// io/ss/st#?name{f:[#],l:[yn],s:[lr]}
#include "/tau/src/cmd/code.h"
#include "/tau/src/cmd/utf8.h"

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <dirent.h>

#include "strequal.h"
#include "readline.h"
#include "basecode.h"
#include "writebuf.h"

#define TABTIBURL	"/io/tib" // read/write tab
#define TABULFURL	"/io/ulf" // upload file(s)
#define TABDATURL	"/io/dat" // open local data
#define TABURLURL	"/io/url" // open local url
#define TABBUFDIR	"/R:"

#define STREAMBUFFERPATHSIZE	256
#define STREAMBUFFERLINESIZE	512

#define tab main
IN tab($) {
  char linebuf[STREAMBUFFERLINESIZE + 1];
  char pathname[STREAMBUFFERPATHSIZE + 1];
  char bufname[STREAMBUFFERPATHSIZE + 1];
//#include BUFLISTDIRSHEADER
//  char *dirbuf = buflistdirs[0];
  CS dirbuf = TABBUFDIR;
  CS querystr = getenv("QUERY_STRING");
  IF (querystr EQNULL) {
    IF ($N GQ 1) {
      querystr = $1; // ./tab "querystring"
    } EL {
      LORN("Content-Type: text/plain");
      LORN("");
      LOGN("{ tab: No query string. }");
      RT 0;
    }
  }
  IN querystrlen = strlen(querystr);
  IF (querystrlen EQ 0) {
      LORN("Content-Type: text/plain");
      LORN("");
      LOGN("{ tab: No query. }");
      RT 0;
  } EL {
// UPDATE THIS : ARE PARAMETERS NEEDED ? also %NN translation
    int framerate = 1;
    char loopmode = 'n';
    if (querystr[querystrlen - 1] == '}') {
      int qpi = querystrlen - 1;
      while (qpi >= 0 && querystr[qpi] != '{')
        { qpi--; }
      if (querystr[qpi] != '{')
        { fprintf(stdout, "{ stream: Bad parameter string. }\n"); return 3; }
      else {
        querystr[qpi] = '\0';
        while (querystr[++qpi] != '}') {
          if (querystr[qpi] == ':') {
            if (querystr[qpi - 1] == 'f') {
              if (querystr[qpi + 1] >= '1' && querystr[qpi + 1] <= '9') {
                framerate = (int)(querystr[qpi + 1] - '0');
                if (querystr[qpi + 2] >= '0' && querystr[qpi + 2] <= '9')
                  { framerate = (framerate * 10) + (int)(querystr[qpi + 2] - '0'); }
              }
            } else if (querystr[qpi - 1] == 'l') {
              if (querystr[qpi + 1] == 'y' || querystr[qpi + 1] == 'n')
                { loopmode = querystr[qpi + 1]; }
            } else if (querystr[qpi - 1] == 's') {
              if (querystr[qpi + 1] >= '0' && querystr[qpi + 1] <= '9')
                { dirbuf = dirbuf; } // cannot change source att
//                { dirbuf = buflistdirs[(querystr[qpi + 1] - '0')]; }
            }
          }
        }
      }
    }
    // split bufname into pathname and filename
    STRF(bufname, "%s", querystr);
    CS filename = bufname;
    CS pathname = NULL;
    IN filepathlen = STRLEN(filename);
    CS bufnc = &filename[filepathlen - 1];
    WIDEC(bufnc, filename, '/');
    IFEQ(*bufnc, '/') {
      IFEQ(*(bufnc + 1), NUL) {
        filename = NULL; // this is a dir ... handle later
        RT 101; // cannot open dirs at this time... TODO: FIX
      } EL {
        *bufnc = NUL;
        filename = bufnc + 1;
        pathname = bufname;
        dirbuf = pathname; // use this dir
      } // bufname splits pathname and filename
    } // EL this filename includes no path
    IN filenamelen = STRLEN(filename);
    CS fileext = NULL;
    bufnc = &filename[filenamelen - 1];
    WIDEC(bufnc, filename, '.');
    IF (*bufnc EQ '.' AND bufnc EQ filename) {
      // this is a hidden file with no tags/extension
      // filename[0] EQ '.' .........................
    } EF (*bufnc EQ '.') { // this is an extension
      *bufnc = NUL;
      fileext = bufnc + 1;
    } // EL this is a file with no tags/extension
    CS filetags = NULL;
    IF (fileext NQNULL) { // filename.tag.tag.tag.ext
      bufnc = filename;
      WINCH(bufnc, '.');
      IFEQ(*bufnc, '.') {
        *bufnc = NUL;
        filetags = bufnc + 1;
      } // EL this is a file with extension but no tags
    } // EL this file cannot have tags because it has no .extension suffix
    // now select lines with :NN suffix
    CS linenum = NUL;
    IF (fileext NQNULL) { // suffix after extension
      bufnc = fileext;
      WINCH(bufnc, ':');
      IFEQ(*bufnc, ':') {
        *bufnc = NUL;
        linenum = bufnc + 1;
      } // EL this with-extension file has no linenum
    } EL { // suffix at end of filename
      bufnc = filename;
      WINCH(bufnc, ':');
      IFEQ(*bufnc, ':') {
        *bufnc = NUL;
        linenum = bufnc + 1;
      } // EL this no-extension file has no linenum
    }
    IN selectline = 0; // surely 0 is the default
    IF (linenum NQNULL) {
      bufnc = linenum;
      WI ISNUMBER(*bufnc) {
        selectline = (selectline * 10) + ((*bufnc) - A0);
        INC bufnc;
      }
    } // EL there is no line number to read

    // old fileext/filetail code was here
    // authentication hash was here
    // querystr debug was here

    // make sure directory exists
    struct stat dirstatus;
    if ((stat(dirbuf, &dirstatus) == -1) || (!S_ISDIR(dirstatus.st_mode)))
      { fprintf(stdout, "{ stream: Error opening directory. }\n"); return 4; }
    else {
      // display header
      fprintf(stdout, "Content-Type: text/html\r\n");
      fprintf(stdout, "Cache-Control: no-cache, no-store, must-revalidate\r\n");
      fprintf(stdout, "Content-Encoding: identity\r\n");
      fprintf(stdout, "Pragma: no-cache\r\n");
      fprintf(stdout, "Access-Control-Allow-Origin: *\r\n");
      fprintf(stdout, "Expires: 0\r\n\r\n");
      fprintf(stdout, "<html><head>\n");
#include "tabcss.h"
      fprintf(stdout, "<script type=\"text/javascript\">\n");
      fprintf(stdout, "  function $$(id) { return document.getElementById(id); }\n");
      fprintf(stdout, "  var inbosel = 0;\n");
      fprintf(stdout, "  var inbexpos = [\n");
      fprintf(stdout, "    [ 5,  5,  5,  5, [ .2,  .2,  .2,  .2], [1,2,3,4,5,6,7,8,9]],\n");
      fprintf(stdout, "    [ 2, 50,  2, 50, [ .2, -.2,  .2, -.2], [0,5,7,9]],\n");
      fprintf(stdout, "    [50,  2,  2, 50, [-.2,  .2,  .2, -.2], [0,6,7,9]],\n");
      fprintf(stdout, "    [ 2, 50, 50,  2, [ .2, -.2, -.2,  .2], [0,5,8,9]],\n");
      fprintf(stdout, "    [50,  2, 50,  2, [-.2,  .2, -.2,  .2], [0,6,8,9]],\n");
      fprintf(stdout, "    [ 1, 50,  1,  1, [  0,   0,   0,   0], [0,1,3,7,8,9]],\n");
      fprintf(stdout, "    [50,  1,  1,  1, [ .2, -.2,  .2, -.2], [0,2,4]],\n");
      fprintf(stdout, "    [ 1,  1,  1, 50, [ .2, -.2,  .2, -.2], [0,1,2,5,6,9]],\n");
      fprintf(stdout, "    [ 1,  1, 50,  1, [ .2, -.2,  .2, -.2], [0,3,4]],\n");
      fprintf(stdout, "    [ 0,  0,  0,  0, [-.3,  .3,   0,   0], [0,1,2,3,4,5,6,7,8]],\n");
      fprintf(stdout, "    [10, 10, 10, 10, [ .2,  .2,  .2,  .2], [1,2,3,4,5,6,7,8,9]]\n");
      fprintf(stdout, "  ];\n");
      fprintf(stdout, "  var inbexranges = [\n");
      fprintf(stdout, "    [], [], [], [], [], [], [], [], [], [], []\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }],\n");
//      fprintf(stdout, "    [{start: 0, limit: 0, pos: [0, 0, 0, 0] }]\n");
      fprintf(stdout, "  ];\n");
      fprintf(stdout, "  var inbexlinks = [ \n");
      fprintf(stdout, "    { t: [9], u: [], d: [], l: [], r: [] },\n");
      fprintf(stdout, "    { t: [2], u: [], d: [3,4,6,8], l: [], r: [2,4,6,8] },\n");
      fprintf(stdout, "    { t: [4], u: [], d: [4,3,5,8], l: [1,3,5,8], r: [] },\n");
      fprintf(stdout, "    { t: [1], u: [1,2,6,7], d: [], l: [], r: [4,2,6,7] },\n");
      fprintf(stdout, "    { t: [3], u: [2,1,5,7], d: [], l: [3,1,5,7], r: [] },\n");
      fprintf(stdout, "    { t: [8], u: [], d: [], l: [], r: [6,2,4] },\n");
      fprintf(stdout, "    { t: [5], u: [], d: [], l: [5,1,3], r: [] },\n");
      fprintf(stdout, "    { t: [4], u: [], d: [8,2,4], l: [], r: [8] },\n");
      fprintf(stdout, "    { t: [7], u: [7,1,3], d: [], l: [7], r: [] },\n");
      fprintf(stdout, "    { t: [6], u: [], d: [], l: [], r: [] }\n");
      fprintf(stdout, "  ];\n");
      fprintf(stdout, "  var linesel = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n");
      fprintf(stdout, "  var zerosel = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n");
      fprintf(stdout, "  var pagesel = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n");
      fprintf(stdout, "  var tabmode = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n");
      fprintf(stdout, "  var lineid = [null, null, null, null, null, null, null, null, null];\n");
      fprintf(stdout, "  var keysdown = { shift: false, reshift: false, control: false };\n");
      fprintf(stdout, "  function rehighlightline(inbex) {\n");
      fprintf(stdout, "    var cel = lineid[inbex];\n");
      fprintf(stdout, "    if (!cel) { return false; }\n");
      fprintf(stdout, "    var celnum = linesel[inbex];\n");
      fprintf(stdout, "    if (zerosel[inbosel] == 1) { celnum = 0; }\n");
      fprintf(stdout, "    var celpre = (celnum == 0) ? 'linezero' : '';\n");
      fprintf(stdout, "    if (cel.className.substr(0, 8) == 'openline')\n");
      fprintf(stdout, "      { celpre = 'openline'; }\n");
//      fprintf(stdout, "    if (celnum == 0) { console.log('0'); return; }\n");
      fprintf(stdout, "    var val = (wispen == 'y') ? 'sel' : 'set';\n");
      fprintf(stdout, "    cel.className = celpre + val;\n");
      fprintf(stdout, "    return true;\n");
      fprintf(stdout, "  }\n");
//--------------------------------------------------------------------------
      fprintf(stdout, "  function ionamebreak(namestr) {\n");
      fprintf(stdout, "    var nsi = -1, pre = 1;\n");
      fprintf(stdout, "    var ns0 = '0'.charCodeAt(0);\n");
      fprintf(stdout, "    var ns9 = '9'.charCodeAt(0);\n");
//      fprintf(stdout, "    var nsla = 'a'.charCodeAt(0);\n");
      fprintf(stdout, "    var nsa = ['', 0, ''];\n");
      fprintf(stdout, "    while (++nsi < namestr.length) {\n");
      fprintf(stdout, "      var nsch = namestr.charAt(nsi);\n");
      fprintf(stdout, "      var nscc = namestr.charCodeAt(nsi);\n");
      fprintf(stdout, "      if (pre == 1) {\n");
      fprintf(stdout, "        if (nscc >= ns0 && nscc <= ns9)\n");
      fprintf(stdout, "          { pre = 0; nsa[1] = nscc - ns0; }\n");
      fprintf(stdout, "        else { nsa[0] += nsch; }\n");
      fprintf(stdout, "      } else {\n");
      fprintf(stdout, "        if (nscc >= ns0 && nscc <= ns9)\n");
      fprintf(stdout, "          { nsa[1] = (nsa[1] * 10) + (nscc - ns0); }\n");
      fprintf(stdout, "        else { nsa[2] = namestr.substr(nsi); break; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return nsa;\n"); // ['pref', 123, 1]
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function ionamediff(diffstr, refstr) {\n");
      fprintf(stdout, "    var dnb = ionamebreak(diffstr);\n");
      fprintf(stdout, "    var rnb = ionamebreak(refstr);\n");
      fprintf(stdout, "    if (dnb[0] != rnb[0]) { return 1; }\n");
      fprintf(stdout, "    if (dnb[1] < rnb[1]) { return -1; }\n");
      fprintf(stdout, "    if (dnb[1] > rnb[1]) { return 1; }\n");
      fprintf(stdout, "    if (dnb[2] < rnb[2]) { return -1; }\n");
      fprintf(stdout, "    if (dnb[2] > rnb[2]) { return 1; }\n");
      fprintf(stdout, "    return (dnb[2] == rnb[2]) ? 0 : 1;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iocleanline(inbex, linum) {\n");
      fprintf(stdout, "    var thatline = $$('in' + inbex + 'ln' + linum + '~');\n");
      fprintf(stdout, "    if (!thatline) { return false; }\n");
      fprintf(stdout, "    thatline.parentElement.removeChild(thatline);\n");
      fprintf(stdout, "    return true;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iolastline(inbex) {\n");
      fprintf(stdout, "    var inbel = $$('in' + inbex);\n");
      fprintf(stdout, "    if (!inbel) { return 0; }\n");
      fprintf(stdout, "    var inlast = inbel.lastElementChild;\n");
      fprintf(stdout, "    if (!inlast) { return 0; }\n");
      fprintf(stdout, "    var inlnum = inlast.firstElementChild;\n");
      fprintf(stdout, "    if (!inlnum) { return 0; }\n");
      fprintf(stdout, "    if (inlnum.className != 'lnum') { return 0; }\n");
      fprintf(stdout, "    var inword = inlnum.innerText;\n");
      fprintf(stdout, "    inword = inword.substr(inword.lastIndexOf('>') + 1);\n");
      fprintf(stdout, "    var inname = ionamebreak(inword);\n");
      fprintf(stdout, "    return inname[1];\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iopageflight(frombex, tobex) {\n");
      fprintf(stdout, "    var thisbox = $$('in' + frombex);\n");
      fprintf(stdout, "    if (!thisbox) { return false; }\n");
      fprintf(stdout, "    var thatline = thisbox.lastElementChild;\n");
      fprintf(stdout, "    if (!thatline) { return false; }\n");
      fprintf(stdout, "    var tlin = ionamebreak(thatline.id);\n");
      fprintf(stdout, "    if (tlin[0] != 'in' || tlin[1] != tolii) { return false; }\n");
      fprintf(stdout, "    var tlln = ionamebreak(tlin[2]);\n");
      fprintf(stdout, "    if (tlln[0] != 'in' || tlln[2] != '~') { return false; }\n");
      fprintf(stdout, "    var tolim = (tobex == 0) ? 9 : tobex;\n");
      fprintf(stdout, "    var tolii = tobex;\n");
      fprintf(stdout, "    while (tolii <= tolim) {\n");
      fprintf(stdout, "      var thatbox = $$('in' + tolii);\n");
      fprintf(stdout, "      if (!thatbox) { continue; }\n");
      fprintf(stdout, "      var thatboxlz = thatbox.firstElementChild;\n");
      fprintf(stdout, "      if (!thatboxlz || !thatboxlz.nextElementSibling)\n");
      fprintf(stdout, "        { tolii++; continue; }\n");
      fprintf(stdout, "      var thatnext = thatboxlz.nextElementSibling;\n");
      fprintf(stdout, "      var tnin = ionamebreak(thatnext.id);\n");
      fprintf(stdout, "      if (tnin[0] != 'in' || tnin[1] != tolii)\n");
      fprintf(stdout, "        { tolii++; continue; }\n");
      fprintf(stdout, "      var tnln = ionamebreak(tnin[2]);\n");
      fprintf(stdout, "      if (tnln[0] != 'ln' || tnln[1] != thatlnum + 1)\n");
      fprintf(stdout, "        { tolii++; continue; }\n");
      fprintf(stdout, "      var newline = document.createElement('div');\n");
      fprintf(stdout, "      newline.id = 'in' + tolii + 'ln' + thatlnum;\n");
      fprintf(stdout, "      newline.innerHTML = thatline.innerHTML;\n");
      fprintf(stdout, "      thatbox.insertBefore(newline, thatnext);\n");
      fprintf(stdout, "      return true;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return false;\n");
      fprintf(stdout, "  }\n");
//--------------------------------------------------------------------------
      fprintf(stdout, "  function highlightline(inbex, linum) {\n");
      fprintf(stdout, "    var cel = lineid[inbex];\n");
      fprintf(stdout, "    if (linum < 0)\n");
      fprintf(stdout, "      { linum = iolastline(inbex) + linum; }\n");
      fprintf(stdout, "    if (linum < 0) { return; }\n");
      fprintf(stdout, "    if (linum == 0 && zerosel[inbex] == 1)\n");
      fprintf(stdout, "      { linum = linesel[inbex]; zerosel[inbex] = 0; }\n");
      fprintf(stdout, "    var nextcel = $$('in' + inbex + 'ln' + linum);\n");
      fprintf(stdout, "    if (cel) {\n");
      fprintf(stdout, "      var ccn = cel.className;\n");
      fprintf(stdout, "      if (ccn == 'sel' || ccn == 'set' || ccn == 'six' ||\n");
      fprintf(stdout, "          ccn == 'sox' || ccn == 'sol' || ccn == 'sal')\n");
      fprintf(stdout, "        { cel.className = (linum == 0) ? 'els' : 'nor'; }\n");
      fprintf(stdout, "      else if (ccn == 'linezerosel' || ccn == 'linezeroset') {\n");
      fprintf(stdout, "        cel.className = 'linezero';\n"); // linum == 0
      fprintf(stdout, "        ioclearline(cel);\n");
      fprintf(stdout, "      } else if (ccn == 'openlinesel' || ccn == 'openlineset') {\n");
      fprintf(stdout, "        cel.className = 'openline';\n"); // linum <= 0
      fprintf(stdout, "        ioclearline(cel);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (nextcel) {\n");
      fprintf(stdout, "      if (linum > 0) {\n");
      fprintf(stdout, "        linesel[inbex] = linum;\n");
      fprintf(stdout, "        zerosel[inbex] = 0;\n");
      fprintf(stdout, "      } else { zerosel[inbex] = 1; }\n");
      fprintf(stdout, "      lineid[inbex] = nextcel;\n");
//      fprintf(stdout, "      if (linum == 0) {\n");
//      fprintf(stdout, "        if (nextcel.className == 'openline')\n");
//      fprintf(stdout, "          { nextcel.className = 'openlinesel'; }\n");
//      fprintf(stdout, "        else { nextcel.className = 'linezerosel'; }\n");
//      fprintf(stdout, "      } else {\n");
    fprintf(stdout, "        rehighlightline(inbex);\n");
//      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function linehighlight(element) {\n");
      fprintf(stdout, "    var inb = ionamebreak(element.id);\n");
      fprintf(stdout, "    var inbex = inb[1];\n");
      fprintf(stdout, "    var lnb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "    var linum = lnb[1];\n");
      fprintf(stdout, "    if (inb[0] == 'in' && lnb[0] == 'ln')\n");
      fprintf(stdout, "      { highlightline(inbex, linum); }\n");
      fprintf(stdout, "    wispswitch();\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function charselect(element) {\n");
      fprintf(stdout, "    var sinel = element.parentElement;\n");
      fprintf(stdout, "    var linel = sinel.parentElement;\n");
      fprintf(stdout, "    var inbel = linel.parentElement;\n");
      fprintf(stdout, "    if (inbel.parentElement.id != 'inbox') { return false; }\n");
      fprintf(stdout, "    var inb = ionamebreak(linel.id);\n");
      fprintf(stdout, "    var inbex = inb[1];\n");
      fprintf(stdout, "    var lnb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "    var linum = lnb[1];\n");
      fprintf(stdout, "    if (inb[0] != 'in' || lnb[0] != 'ln') { return false; }\n");
      fprintf(stdout, "    var wispel = $$(linel.id + '=');\n");
      fprintf(stdout, "    if (!wispel) { return false; }\n");
      fprintf(stdout, "    sinel.insertBefore(wispel, element);\n");
      fprintf(stdout, "    return true;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var highlightpending = [];\n");
      fprintf(stdout, "  function highlightwhenadded(inbex, linum, select) {\n");
      fprintf(stdout, "    highlightpending.push([inbex, linum, select]);\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function highlightifpending(inbex, linum) {\n");
      fprintf(stdout, "    if (highlightpending.length > 0) {\n");
      fprintf(stdout, "      var hli = -1;\n");
      fprintf(stdout, "      while (++hli < highlightpending.length) {\n");
      fprintf(stdout, "        if (highlightpending[hli][0] == inbex) {\n");
      fprintf(stdout, "          if (highlightpending[hli][1] == linum) {\n");
      fprintf(stdout, "            highlightline(inbex, linum);\n");
      fprintf(stdout, "            if (highlightpending[hli][2] == 1)\n");
      fprintf(stdout, "              { wispopen('h'); }\n");
      fprintf(stdout, "            \n"); // neec to remove highlight from list
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function highlightnextline(count) {\n");
      fprintf(stdout, "    var reverse = 0; if (count < 0)\n");
      fprintf(stdout, "      { count = 0 - count; reverse = 1; }\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    var csl = linesel[inbosel];\n");
      fprintf(stdout, "    if (zerosel[inbosel] == 1)\n");
      fprintf(stdout, "      { csl = 0; }\n");
      fprintf(stdout, "    var csp = pagesel[inbosel];\n");
      fprintf(stdout, "    var csplist = inbexranges[inbosel];\n");
      fprintf(stdout, "    var cel = $$('in' + inbex + 'ln' + csl);\n");
//      fprintf(stdout, "    if (csp > 0 && csp < csplist.length)\n");
//      fprintf(stdout, "      { cel = $$('in' + csi + '.' + csp + 'ln' + csl); }\n");
// ^^ fix later ... current page will always be 0, no csp
      fprintf(stdout, "    if (!cel || count == 0) {\n"); // || (0) count == 0 ..
      fprintf(stdout, "      highlightline(inbosel, 0);\n");
      fprintf(stdout, "    } else {\n");
      fprintf(stdout, "      while (--count >= 0) {\n");
      fprintf(stdout, "        var nextcel = cel;\n");
      fprintf(stdout, "        if (reverse == 1 && cel.id.substr(-3) != 'ln0')\n");
      fprintf(stdout, "          { nextcel = cel.previousElementSibling; }\n");
      fprintf(stdout, "        else { nextcel = cel.nextElementSibling; }\n");
      fprintf(stdout, "        if (nextcel) {\n");
      fprintf(stdout, "          var nci = ionamebreak(nextcel.id);\n");
      fprintf(stdout, "          if (nci[0] == 'in') {\n");
      fprintf(stdout, "            var ncl = ionamebreak(nci[2]);\n");
      fprintf(stdout, "            if (ncl[0] == 'ln') {\n");
      fprintf(stdout, "              highlightline(nci[1], ncl[1]);\n");
      fprintf(stdout, "            }\n");
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        } else { break; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
//      fprintf(stdout, "    ioqueuemods(inbex);\n");
//      fprintf(stdout, "    iohandlequeue(inbex);\n");
      fprintf(stdout, "    wispswitch();\n");
      fprintf(stdout, "    wispfocus();\n");
//      fprintf(stdout, "    wispapplytriggers();\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function highlightprevline(count) {\n");
      fprintf(stdout, "    highlightnextline(0 - count);\n");
      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  function iohighlightnextline(count) {\n");
//      fprintf(stdout, "    var inbex = inbosel;\n");
//      fprintf(stdout, "    highlightnextline(count);\n");
//      fprintf(stdout, "    ioqueuemods(inbex);\n");
//      fprintf(stdout, "    iohandlequeue(inbex);\n");
//      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  function iohighlightprevline(count) {\n");
//      fprintf(stdout, "    var inbex = inbosel;\n");
//      fprintf(stdout, "    highlightnextline(0 - count);\n");
//      fprintf(stdout, "    ioqueuemods(inbex);\n");
//      fprintf(stdout, "    iohandlequeue(inbex);\n");
//      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  function mousehighlight(element)\n");
//      fprintf(stdout, "  { var newlinesel = (element.id.substr(0, 7) == 'newline') ? 7\n");
//      fprintf(stdout, "                   : ((element.id.substr(0, 4) == 'line') ? 4 : -1);\n");
//      fprintf(stdout, "    if (newlinesel != -1) { newlinesel = parseInt(element.id.substr(newlinesel)); }\n");
//      fprintf(stdout, "    if (keysdown.shift == true && newlinesel != -1)\n");
//      fprintf(stdout, "    { if (newlinesel - linesel < 0) { prevlines(1); }\n");
//      fprintf(stdout, "      if (newlinesel - linesel > 0) { nextlines(1); }\n");
//      fprintf(stdout, "      keysdown.shift = keysdown.reshift; keysdown.reshift = false;  }  }\n");
      fprintf(stdout, "  var seekinbox = 0;\n");
      fprintf(stdout, "  var seeklinum = 0;\n");
      fprintf(stdout, "  var seektarget = 0;\n");
//[null, null, null, null, null,");
//      fprintf(stdoutm "                null, null, null, null, null];\n");
      fprintf(stdout, "  var seekspin = ['&gt;', '&gt;'];\n");
      fprintf(stdout, "  var seekspic = ['clr0', 'clr1'];\n");
      fprintf(stdout, "  var seekii = -1;\n");
      fprintf(stdout, "  var seeken = 'n';\n");
// no list yet - each CUE overwrites current seek. CUE @n | t == FIN
//      fprintf(stdout, "  function seekstarter() {\n");
//      fprintf(stdout, "    var thisseek = seekid[inbosel];\n");
//      fprintf(stdout, "    \n");
//      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function seekspinner(spintype) {\n");
//      fprintf(stdout, "    if (copying || pasting) { return; }\n");
      fprintf(stdout, "    var thisseek = $$('in' + seekinbox + 'ln' + seeklinum);\n");
      fprintf(stdout, "    if (!thisseek) { return false; }\n");
      fprintf(stdout, "    var thisseekfc = thisseek.firstElementChild;\n");
      fprintf(stdout, "    if (!thisseekfc) { return false; }\n");
      fprintf(stdout, "    if (thisseek.parentElement.id != 'in' + seekinbox)\n");
      fprintf(stdout, "      { console.log('seek inbox mismatch'); }\n");
      fprintf(stdout, "    else if (thisseekfc.className != 'lnum')\n");
      fprintf(stdout, "      { console.log('seek class mismatch'); }\n");
      fprintf(stdout, "    else if (spintype == 'c') {\n");
      fprintf(stdout, "      thisseekfc.innerHTML = seeklinum + '';\n");
      fprintf(stdout, "    } else if (spintype == 's') {\n");
      fprintf(stdout, "      seekii = (seekii + 1) %% seekspin.length;\n");
      fprintf(stdout, "      seekiv = '<span class=\"' + seekspic[seekii];\n");
      fprintf(stdout, "      seekiv += '\">' + seekspin[seekii] + '</span>';\n");
//      fprintf(stdout, "    var wisptext = '<i style=\"color: ' + wispspan[wispen] + ';\">';\n");
      fprintf(stdout, "      thisseekfc.innerHTML = seekiv + seeklinum;\n");
      fprintf(stdout, "    } return true;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function seekprefix(linel) {\n");
      fprintf(stdout, "    var linelnum = linel.firstElementChild;\n");
      fprintf(stdout, "    if (!linelnum || linelnum.className != 'lnum') { return ']#'; }\n");
      fprintf(stdout, "    var linersqb = linelnum.nextElementSibling;\n");
      fprintf(stdout, "    if (linersqb && linersqb.className.substr(-4) == 'wisp')\n");
      fprintf(stdout, "      { linersqb = linersqb.nextElementSibling; }\n");
      fprintf(stdout, "    if (!linersqb || linersqb.innerText != ']') { return ''; }\n");
      fprintf(stdout, "    var linechar = linersqb.nextElementSibling;\n");
      fprintf(stdout, "    if (linechar && linechar.className.substr(-4) == 'wisp')\n");
      fprintf(stdout, "      { linechar = linechar.nextElementSibling; }\n");
      fprintf(stdout, "    if (!linechar) { return ']'; }\n");
      fprintf(stdout, "    return ']' + linechar.innerText;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function seekstepper() {\n");
      fprintf(stdout, "    var seekelid = 'in' + seekinbox + 'ln' + seeklinum;\n");
      fprintf(stdout, "    var seekelem = $$(seekelid);\n");
      fprintf(stdout, "    if (seekspinner('c') && seekelem) {\n");
      fprintf(stdout, "      var seeknext = 1;\n");
      fprintf(stdout, "      var seekthat = seekelem.nextElementSibling;\n");
      fprintf(stdout, "      while (seekthat) { console.log(seekprefix(seekthat));\n");
      fprintf(stdout, "        if (seekprefix(seekthat) == ']-') {\n");
      fprintf(stdout, "          seekthat = seekthat.nextElementSibling;\n");
      fprintf(stdout, "        } else { break; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      if (!seekthat) { return false; }\n");
      fprintf(stdout, "      var inb = ionamebreak(seekthat.id);\n");
      fprintf(stdout, "      if (inb[0] != 'in') { return false; }\n");
      fprintf(stdout, "      if (inb[1] != seekinbox)\n");
      fprintf(stdout, "        { console.log('seek inbox mismatch'); return false; }\n");
      fprintf(stdout, "      var lnb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "      if (lnb[0] != 'ln') { return false; }\n");
      fprintf(stdout, "      seeklinum = lnb[1];\n");
      fprintf(stdout, "      seektriggeropen(seekinbox);\n");
      fprintf(stdout, "      return seekspinner('s');\n");
      fprintf(stdout, "    } else { return  false; }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var wispid = [null, null, null, null, null,");
      fprintf(stdout, "                null, null, null, null, null];\n");
      fprintf(stdout, "  var wispspan = { 'y': '#000', 'n': '#777' };\n");
      fprintf(stdout, "  var wispspin = ['&#47;', '&#45;', '&#92;', '&#124;'];\n");
      fprintf(stdout, "  var wisptimer = null;\n");
      fprintf(stdout, "  var wispii = -1;\n");
      fprintf(stdout, "  var wispen = 'n';\n");
      fprintf(stdout, "  var wispms = 200;\n");
      fprintf(stdout, "  var wispclean = [];\n");
      fprintf(stdout, "  function wisptoggle() {\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    if (wispen == 'n' && iomodlist[inbex].length > 0)\n");
      fprintf(stdout, "      { return 0; }\n");
      fprintf(stdout, "    wispen = (wispen == 'n') ? 'y' : 'n';\n");
      fprintf(stdout, "    if (wispen == 'n') {\n");
      fprintf(stdout, "      if (wisptimer) { clearInterval(wisptimer); }\n");
      fprintf(stdout, "      if (wispid[inbex]) { wispid[inbex].innerHTML = ''; }\n");
      fprintf(stdout, "      ioqueuemods(inbex);\n");
      fprintf(stdout, "      iohandlequeue(inbex);\n");
      fprintf(stdout, "      rehighlightline(inbosel);\n");
      fprintf(stdout, "      return 0;\n");
      fprintf(stdout, "    } else if (wispen == 'y') {\n");
      fprintf(stdout, "      wisptimer = setInterval(function() { wispspinner(); }, wispms);\n");
      fprintf(stdout, "      wispswitch();\n");
      fprintf(stdout, "      rehighlightline(inbosel);\n");
      fprintf(stdout, "      return 1;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisptoggletab() {\n");
      fprintf(stdout, "    var thisbox = $$('in' + inbosel);\n");
      fprintf(stdout, "    var thisboxmode = tabmode[inbosel];\n");
      fprintf(stdout, "    if (thisbox) {\n");
//      fprintf(stdout, "      if (thisboxmode == 0) {\n");
//      fprintf(stdout, "        thisboxmode = 1;\n");
//      fprintf(stdout, "      } else { thisboxmode = 0; }\n");
      fprintf(stdout, "      thisboxmode = wisptoggle();\n");
      fprintf(stdout, "      tabmode[inbosel] = thisboxmode;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisptoggleesc(shift) {\n");
      fprintf(stdout, "    var thisbox = $$('in' + inbosel);\n");
      fprintf(stdout, "    if (thisbox) {\n");
      fprintf(stdout, "      if (shift) {\n"); // switch window
      fprintf(stdout, "        if (thisbox.className == 'act') {\n");
      fprintf(stdout, "          thisbox.className = 'esc';\n");
      fprintf(stdout, "        } else if (thisbox.className == 'esc') {\n");
      fprintf(stdout, "          thisbox.className = 'act';\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "        document.activeElement.blur();\n");
      fprintf(stdout, "      } else {\n"); // line zero
      fprintf(stdout, "        highlightline(inbosel, 0);\n");
      fprintf(stdout, "        wispswitch();\n");
      fprintf(stdout, "        document.activeElement.blur();\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisptogglestrike() {\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    var thisbox = $$('in' + inbosel);\n");
      fprintf(stdout, "    if (thisbox) {\n");
      fprintf(stdout, "      wispgoto('tsol');\n");
      fprintf(stdout, "      var thislnum = linesel[inbosel];\n");
      fprintf(stdout, "      var thislinel = $$(thisbox.id + 'ln' + thislnum);\n");
      fprintf(stdout, "      var thislnumel = thislinel.firstElementChild;\n");
      fprintf(stdout, "      if (!thislnumel) { return; }\n");
      fprintf(stdout, "      var thislnc0el = thislnumel.nextElementSibling;\n");
      fprintf(stdout, "      if (!thislnc0el) { return; }\n");
      fprintf(stdout, "      var thislnumc = thislnumel.className;\n");
      fprintf(stdout, "      if (thislnumc != 'lnum') { return; }\n");
      fprintf(stdout, "      var thislnc0c = thislnc0el.className;\n");
      fprintf(stdout, "      if (thislnc0c != 'wisp') { return; }\n");
      fprintf(stdout, "      var thislnc1el = (thislnc0el) ? thislnc0el.nextElementSibling : null;\n");
      fprintf(stdout, "      var thislnc2el = (thislnc1el) ? thislnc1el.nextElementSibling : null;\n");
      fprintf(stdout, "      var thislnc1c = (thislnc1el) ? thislnc1el.className : null;\n");
      fprintf(stdout, "      var thislnc2c = (thislnc2el) ? thislnc2el.className : null;\n");
//      fprintf(stdout, "      var thislnc1h = (thislnc1el) ? thislnc1el.innerHTML : null;\n");
//      fprintf(stdout, "      var thislnc2h = (thislnc2el) ? thislnc2el.innerHTML : null;\n");
      fprintf(stdout, "      var thisboxmode = tabmode[inbosel];\n");
      fprintf(stdout, "      if (thislnc1c == 'rsqb' && thislnc2c == 'dash') {\n");
      fprintf(stdout, "        wispgoto('trht');\n");	
      fprintf(stdout, "        wispgoto('trht');\n");	
      fprintf(stdout, "        wispbackspace(2, 0);\n");	
      fprintf(stdout, "        ioqueuemods(inbex);\n");	
      fprintf(stdout, "        iohandlequeue(inbex);\n");
      fprintf(stdout, "      } else if (thislnc1c != 'rsqb' || thislnc2c != 'dash') {\n");
      fprintf(stdout, "        wispkey(']');\n");	
      fprintf(stdout, "        wispkey('-');\n");	
      fprintf(stdout, "        ioqueuemods(inbex);\n");	
      fprintf(stdout, "        iohandlequeue(inbex);\n");	
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var wisp = { index: 0, range: [0, 0] };\n");
      fprintf(stdout, "  function wispascii(letter) {\n");
      fprintf(stdout, "    if (!letter) { return 0; }\n");
      fprintf(stdout, "    else if (letter.length > 1) {\n");
      fprintf(stdout, "      if (letter == '&nbsp;') { return ' '.charCodeAt(0); }\n");
      fprintf(stdout, "      if (letter == '&apos;') { return '\\''.charCodeAt(0); }\n");
      fprintf(stdout, "      if (letter == '&quot;') { return '\"'.charCodeAt(0); }\n");
      fprintf(stdout, "      if (letter == '&amp;') { return '&'.charCodeAt(0); }\n");
      fprintf(stdout, "      if (letter == '&lt;') { return '<'.charCodeAt(0); }\n");
      fprintf(stdout, "      if (letter == '&gt;') { return '>'.charCodeAt(0); }\n");
      fprintf(stdout, "      if (letter == '&bsol;') { return '\\\\'.charCodeAt(0); }\n");
      fprintf(stdout, "    } else if (letter.length == 1) {\n");
      fprintf(stdout, "      return letter.charCodeAt(0);\n");
      fprintf(stdout, "    } else { return 0; }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisplinechecksum() {\n");
      fprintf(stdout, "    if (!lineid[inbosel] || !wispid[inbosel]) { return; }\n");
      fprintf(stdout, "    var linesum = 0;\n");
      fprintf(stdout, "    var charid = lineid[inbosel].firstChild;\n");
      fprintf(stdout, "    while (charid = charid.nextSibling) {\n");
      fprintf(stdout, "      linesum += wispascii(charid.innerHTML);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return linesum;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisplinelen() {\n");
      fprintf(stdout, "    if (!lineid[inbosel] || !wispid[inbosel]) { return; }\n");
      fprintf(stdout, "    var linelen = 0;\n");
      fprintf(stdout, "    var charid = lineid[inbosel].firstChild;\n");
      fprintf(stdout, "    while (charid = charid.nextSibling) {\n");
      fprintf(stdout, "      linelen++;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return linelen;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisplinebasecode() {\n");
      fprintf(stdout, "    if (!lineid[inbosel] || !wispid[inbosel]) { return; }\n");
      fprintf(stdout, "    var linecode = '';\n");
      fprintf(stdout, "    var charid = lineid[inbosel].firstChild;\n");
      fprintf(stdout, "    while (charid = charid.nextSibling) {\n");
      fprintf(stdout, "      var charcode = wispascii(charid.innerHTML);\n");
      fprintf(stdout, "      var charc0 = charcode % 16;\n");
      fprintf(stdout, "      var charc1 = (charcode - charc0) / 16;\n");
      fprintf(stdout, "      linecode += String.fromCharCode(charc1 + 65);\n");
      fprintf(stdout, "      linecode += String.fromCharCode(charc0 + 65);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return linecode;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function stringbasecode(string) {\n");
      fprintf(stdout, "    var bcode = '';\n");
      fprintf(stdout, "    var sti = -1;\n");
      fprintf(stdout, "    while (++sti < string.length) {\n");
      fprintf(stdout, "      var charcode = string.charCodeAt(sti);\n");
      fprintf(stdout, "      var charc0 = charcode %% 16;\n");
      fprintf(stdout, "      var charc1 = (charcode - charc0) / 16;\n");
      fprintf(stdout, "      bcode += String.fromCharCode(charc1 + 65);\n");
      fprintf(stdout, "      bcode += String.fromCharCode(charc0 + 65);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return bcode;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function basecodestring(basecode) {\n");
      fprintf(stdout, "    var str = '';\n");
      fprintf(stdout, "    var sti = -1;\n");
      fprintf(stdout, "    while (sti < basecode.length) {\n");
      fprintf(stdout, "      var charc1 = basecode.charCodeAt(++sti) - 65;\n");
      fprintf(stdout, "      var charc0 = basecode.charCodeAt(++sti) - 65;\n");
      fprintf(stdout, "      var charcode = (charc1 * 16) + charc0;\n");
      fprintf(stdout, "      if (charcode >= 32 && charcode <= 126)\n");
      fprintf(stdout, "        { str += String.fromCharCode(charcode); }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return str;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function htmlcodestring(basecodestr) {\n");
      fprintf(stdout, "    var str = '';\n");
      fprintf(stdout, "    var sti = 0;\n");
      fprintf(stdout, "    while (sti < basecodestr.length) {\n");
      fprintf(stdout, "      var charc = basecodestr.charAt(sti++);\n");
      fprintf(stdout, "      if (charc == ' ') { charc = '&nbsp;'; }\n");
      fprintf(stdout, "      if (charc == '\\'') { charc = '&apos;'; }\n");
      fprintf(stdout, "      if (charc == '\"') { charc = '&quot;'; }\n");
      fprintf(stdout, "      if (charc == '&') { charc = '&amp;'; }\n");
      fprintf(stdout, "      if (charc == '<') { charc = '&lt;'; }\n");
      fprintf(stdout, "      if (charc == '>') { charc = '&gt;'; }\n");
      fprintf(stdout, "      if (charc == '\\\\') { charc = '&bsol;'; }\n");
      fprintf(stdout, "      str += '' + charc;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return str;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var wispmesscolour = '';\n");
      fprintf(stdout, "  function wispfocus() {\n");
      fprintf(stdout, "    if (wispid[inbosel])\n");
      fprintf(stdout, "      { wispid[inbosel].focus(); }\n");
      fprintf(stdout, "    wispmesscolour = '';\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispswitch() {\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    var newline = lineid[inbex];\n");
      fprintf(stdout, "    if (!newline || !newline.id) { return; }\n");
      fprintf(stdout, "    var oldwisp = wispid[inbex];\n");
      fprintf(stdout, "    var newwisp = $$(newline.id + '=');\n");
      fprintf(stdout, "    if (oldwisp == newwisp) { return; }\n");
      fprintf(stdout, "    if (oldwisp) {\n");
      fprintf(stdout, "      oldwisp.innerHTML = '';\n");
      fprintf(stdout, "      if (touch.enabled)\n");
      fprintf(stdout, "        { oldwisp.contentEditable = false; }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    wispid[inbex] = newwisp;\n");
      fprintf(stdout, "    if (touch.enabled) {\n"); // && !copying && !pasting) {\n");
      fprintf(stdout, "      if (touch.lastwasmulti)\n");
      fprintf(stdout, "        { newwisp.contentEditable = false; }\n");
      fprintf(stdout, "      else { newwisp.contentEditable = true; }\n");
      fprintf(stdout, "      wispfocus();\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispinline() {\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    var wispline = thiswisp.parentElement;\n");
      fprintf(stdout, "    var inline = (wispline != thisline) ? true : false;\n");
      fprintf(stdout, "    return inline;\n");
      fprintf(stdout, "  }\n");
////////      fprintf(stdout, "  function thatwispgoto(symbol, save) {\n");
      fprintf(stdout, "  function wispgoto(symbol, save) {\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    var wispline = thiswisp.parentElement;\n");
//      fprintf(stdout, "      { thisline = thiswisp.parentElement; }\n");
      fprintf(stdout, "    if (!thisline || !thiswisp) { return false; }\n");
//      fprintf(stdout, "    if (thisline.id.substr(-3) == 'ln0') { return false; }\n");
      fprintf(stdout, "    var thiswisppr = thiswisp.previousElementSibling;\n");
      fprintf(stdout, "    var thiswispnx = thiswisp.nextElementSibling;\n");
      fprintf(stdout, "    var inline = (wispline != thisline) ? true : false;\n");
      fprintf(stdout, "    if (symbol == 'tlin') {\n");
      fprintf(stdout, "      if (wispline != thisline && thiswisppr)\n"); // inline haschar
      fprintf(stdout, "        { wispline.insertBefore(thiswisp, thiswisppr); }\n");
      fprintf(stdout, "      else { return false; }\n");
      fprintf(stdout, "    } else if (symbol == 'trin') {\n");
      fprintf(stdout, "      if (wispline != thisline && thiswispnx)\n");
      fprintf(stdout, "        { wispline.insertBefore(thiswisp, thiswispnx.nextElementSibling); }\n");
      fprintf(stdout, "      else { return false; }\n");
      fprintf(stdout, "    } else if (symbol == 'tlft' || symbol == 'tlth') {\n");
//      fprintf(stdout, "      if (thiswisppr && thiswisppr.className != 'lnum')\n");
//      fprintf(stdout, "        if (thiswisppr && thiswisppr.className == 'lnum')\n");
  //    fprintf(stdout, "      if (thiswisppr && ((wispline != thisline) ||\n");
  //    fprintf(stdout, "          thiswisppr.previousElementSibling))\n");
      fprintf(stdout, "      if (wispline != thisline && thiswisppr)\n"); // inline haschar
      fprintf(stdout, "        { wispline.insertBefore(thiswisp, thiswisppr); }\n");
      fprintf(stdout, "      else if (wispline != thisline && !thiswisppr)\n"); // inline nochar
      fprintf(stdout, "        { thisline.insertBefore(thiswisp, wispline); }\n");
      fprintf(stdout, "      else if (wispline == thisline && thiswisppr) {\n"); // noline haschar
      fprintf(stdout, "        if (thiswisppr.className != 'lnum')\n");
      fprintf(stdout, "          { thiswisppr.insertBefore(thiswisp, null); }\n");
      fprintf(stdout, "        else if (symbol == 'tlth') { wispgoto('peol', save); } else { return false; }\n");
      fprintf(stdout, "      } else if (symbol == 'tlth') { wispgoto('peol', save); } else { return false; }\n");
//      fprintf(stdout, "      else if (wispline == thisline && !thiswisppr)\n");
//      fprintf(stdout, "        { wispgoto('peol'); }\n");
//      fprintf(stdout, "      else { if (symbol == 'tlth')\n");
//      fprintf(stdout, "        { wispgoto('peosl'); } else { return false; } }\n");
      fprintf(stdout, "    } else if (symbol == 'trht' || symbol == 'trth') {\n");
      fprintf(stdout, "      if (wispline != thisline && thiswispnx)\n");
      fprintf(stdout, "        { wispline.insertBefore(thiswisp, thiswispnx.nextElementSibling); }\n");
      fprintf(stdout, "      else if (wispline != thisline && !thiswispnx) {\n");
      fprintf(stdout, "        var nextwispline = wispline.nextElementSibling;\n");
      fprintf(stdout, "        if (nextwispline && symbol == 'trth')\n");
      fprintf(stdout, "          { nextwispline.insertBefore(thiswisp, nextwispline.firstElementChild); }\n");
      fprintf(stdout, "        else if (symbol == 'trth') { wispgoto('nsol', save); } else { return false; }\n");
      fprintf(stdout, "      } else if (wispline == thisline && thiswispnx)\n");
      fprintf(stdout, "        { thiswispnx.insertBefore(thiswisp, thiswispnx.firstElementChild); }\n");
      fprintf(stdout, "      else if (symbol == 'trth') { wispgoto('nsol', save); } else { return false; }\n");
//      fprintf(stdout, "      if (thiswispnx) {\n");
//      fprintf(stdout, "        if (thiswispnx.tagName == 'DIV') {\n");
//      fprintf(stdout, "          var thiswispchnx = thiswispnx.firstElementChild;\n");
//      fprintf(stdout, "          thiswispnx.insertBefore(thiswisp, thiswispchnx);\n");
//      fprintf(stdout, "        } else {\n");
//      fprintf(stdout, "          var thiswispnxnx = thiswispnx.nextElementSibling;\n");
//      fprintf(stdout, "          wispline.insertBefore(thiswisp, thiswispnxnx);\n");
//      fprintf(stdout, "        }\n");
//      fprintf(stdout, "      } else if (inline && cansubline) {\n"); or nsol
//      fprintf(stdout, "      } else { if (symbol == 'trth')\n");
//      fprintf(stdout, "        { wispgoto('nsosl'); } else { return false; } }\n");
//      fprintf(stdout, "    } else if (symbol == 'psol' || symbol == 'nsol') {\n");
//      fprintf(stdout, "      if (symbol == 'psol')\n");
//      fprintf(stdout, "        { highlightprevline(1); }\n");
//      fprintf(stdout, "      else { highlightnextline(1); }\n");
//      fprintf(stdout, "      while (wispgoto('tlft'));\n");
      fprintf(stdout, "    } else if (symbol == 'peol' || symbol == 'pl') {\n");
      fprintf(stdout, "      var wp = wisppos();\n");
      fprintf(stdout, "      highlightprevline(1);\n");
      fprintf(stdout, "      if (save) {\n");
      fprintf(stdout, "        ioqueuemods(inbosel);\n");
      fprintf(stdout, "        iohandlequeue(inbosel);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      if (symbol == 'peol') { wispgoto('teol'); }\n");
      fprintf(stdout, "      if (symbol == 'pl') { wisppos(wp); }\n");
      fprintf(stdout, "    } else if (symbol == 'nsol' || symbol == 'nl') {\n");
      fprintf(stdout, "      var wp = wisppos();\n");
      fprintf(stdout, "      highlightnextline(1);\n");
      fprintf(stdout, "      if (save) {\n");
      fprintf(stdout, "        ioqueuemods(inbosel);\n");
      fprintf(stdout, "        iohandlequeue(inbosel);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      if (symbol == 'nsol') { wispgoto('tsol'); }\n");
      fprintf(stdout, "      if (symbol == 'nl') { wisppos(wp); }\n");
      fprintf(stdout, "    } else if (symbol == 'peosl' || symbol == 'psl') {\n");
      fprintf(stdout, "      if (thisline != wispline) {\n");
      fprintf(stdout, "        var wp = wisppos();\n");
      fprintf(stdout, "        var wlpr = wispline.previousElementSibling;\n");
      fprintf(stdout, "        if (wlpr && wlpr.className != 'lnum')\n");
      fprintf(stdout, "          { wlpr.insertBefore(thiswisp, null); }\n");
      fprintf(stdout, "        else { wispgoto('pl', save); }\n");
      fprintf(stdout, "        if (symbol == 'psl' && wp >= 0) { wisppos(wp); }\n");
      fprintf(stdout, "      } else if (symbol == 'peosl') { wispgoto('teol'); }\n");
      fprintf(stdout, "        else if (symbol == 'psl') { wispgoto('pl', save); }\n");
      fprintf(stdout, "    } else if (symbol == 'nsosl' || symbol == 'nsl') {\n");
      fprintf(stdout, "      if (thisline != wispline) {\n");
      fprintf(stdout, "        var wp = wisppos();\n");
      fprintf(stdout, "        var wlnx = wispline.nextElementSibling;\n");
      fprintf(stdout, "        if (wlnx) { wlnx.insertBefore(thiswisp, wlnx.firstChild); }\n");
      fprintf(stdout, "        else { wispgoto('nl', save); }\n");
      fprintf(stdout, "        if (symbol == 'nsl' && wp >= 0) { wisppos(wp); }\n");
      fprintf(stdout, "      } else if (symbol == 'nsosl') { wispgoto('tsol'); }\n");
      fprintf(stdout, "        else if (symbol == 'nsl') { wispgoto('nl', save); }\n");
      fprintf(stdout, "    } else if (symbol == 'tsol') {\n"); // this start of line
      fprintf(stdout, "      var lnumel = thisline.firstElementChild;\n");
      fprintf(stdout, "      if (thisline != wispline) {\n");
      fprintf(stdout, "        while (wispgoto('tlin'));\n");
      fprintf(stdout, "      } else if (lnumel.className == 'lnum') {\n");
      fprintf(stdout, "        var linel = lnumel.nextElementSibling;\n");
      fprintf(stdout, "        if (linel.className == 'wisp')\n");
      fprintf(stdout, "          { linel = linel.nextElementSibling; }\n");
      fprintf(stdout, "        if (linel.className == 'line')\n");
      fprintf(stdout, "          { linel.insertBefore(thiswisp, linel.firstChild); }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    } else if (symbol == 'teol') {\n");
      fprintf(stdout, "      var lnumel = thisline.firstElementChild;\n");
      fprintf(stdout, "      if (thisline != wispline) {\n");
      fprintf(stdout, "        while (wispgoto('trin'));\n");
      fprintf(stdout, "      } else if (lnumel.className == 'lnum') {\n");
      fprintf(stdout, "        var linel = lnumel.nextElementSibling;\n");
      fprintf(stdout, "        if (linel.className == 'wisp')\n");
      fprintf(stdout, "          { linel = linel.nextElementSibling; }\n");
      fprintf(stdout, "        if (linel.className == 'line')\n");
      fprintf(stdout, "          { linel.insertBefore(thiswisp, null); }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    } else if (symbol == 'jl10') {\n");
      fprintf(stdout, "      jleft = 10; while (wispgoto('tlth') && --jleft);\n");
      fprintf(stdout, "    } else if (symbol == 'jr10') {\n");
      fprintf(stdout, "      jrght = 10; while (wispgoto('trth') && --jrght);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return true;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var wispactionpath = [];\n");
      fprintf(stdout, "  function wispretreat(shift) {\n");
      fprintf(stdout, "    var where = (shift) ? 'home' : 'back';\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisptakeaction(shift) {\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    if (!thisline || !thiswisp) { return false; }\n");
      fprintf(stdout, "    var thislnum = thisline.firstElementChild;\n");
      fprintf(stdout, "    if (!thislnum || thislnum.className != 'lnum') { return false; }\n");
      fprintf(stdout, "    var thisrsqb = thislnum.nextElementSibling;\n");
      fprintf(stdout, "    if (!thisrsqb || thisrsqb.className != 'rsqb') { return false; }\n");
      fprintf(stdout, "    var thisprev = thiswisp.previousElementSibling;\n");
      fprintf(stdout, "    if (!thisprev) { return false; }\n");
      fprintf(stdout, "    var where = (shift) ? 'here' : 'there';\n");
      fprintf(stdout, "    var thistype = seekprefix(thisline);\n");
      fprintf(stdout, "    var thisword = '';\n");
      fprintf(stdout, "    if (thistype == '][') {\n");
      fprintf(stdout, "      var aword = '';\n");
      fprintf(stdout, "      var thisnext = thiswisp.nextElementSibling;\n");
      fprintf(stdout, "      while (thisnext.className != 'actend') {\n");
      fprintf(stdout, "        aword = aword.concat(thisnext.innerText);\n");
      fprintf(stdout, "        thisnext = thisnext.nextElementSibling;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      thisword = 'action ' + aword;\n");
      fprintf(stdout, "    } else if (thistype == ']:') {\n");
      fprintf(stdout, "      var cword = '';\n");
      fprintf(stdout, "      var thisnext = thisrsqb.nextElementSibling;\n");
      fprintf(stdout, "      while (thisnext) {\n");
      fprintf(stdout, "        if (thisnext.className.substr(-4) != 'wisp')\n");
      fprintf(stdout, "          { cword = cword.concat(thisnext.innerText); }\n");
      fprintf(stdout, "        thisnext = thisnext.nextElementSibling;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      thisword = 'command ' + cword.substr(1);\n");
      fprintf(stdout, "    } else if (thistype == ']=') {\n");
      fprintf(stdout, "      var dword = '';\n");
      fprintf(stdout, "      var thisnext = thisrsqb.nextElementSibling;\n");
      fprintf(stdout, "      while (thisnext) {\n");
      fprintf(stdout, "        if (thisnext.className.substr(-4) != 'wisp')\n");
      fprintf(stdout, "          { dword = dword.concat(thisnext.innerText); }\n");
      fprintf(stdout, "        thisnext = thisnext.nextElementSibling;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      thisword = 'datasrc ' + dword.substr(1);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    console.log(thisword);\n");
      fprintf(stdout, "    return (thisword != '')  ? true : false;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispgotoaction(where) {\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    if (!thisline || !thiswisp) { return false; }\n");
      fprintf(stdout, "    var thislnum = thisline.firstElementChild;\n");
      fprintf(stdout, "    if (!thislnum || thislnum.className != 'lnum') { return 0; }\n");
//      fprintf(stdout, "    var thisrsqb = thislnum.nextElementSibling;\n");
//      fprintf(stdout, "    if (!thisrsqb || thisrsqb.className != 'rsqb') { return 0; }\n");
      fprintf(stdout, "    var goto = (where == 'prev') ? 'tlft' : 'trht';\n");
      fprintf(stdout, "    var thisprev = thiswisp.previousElementSibling;\n");
      fprintf(stdout, "    var thisnext = thiswisp.nextElementSibling;\n");
      fprintf(stdout, "    if (where == 'prev' && !thisprev) { return 0; }\n");
      fprintf(stdout, "    if (where == 'next' && !thisnext) { return 0; }\n");
      fprintf(stdout, "    if (where == 'prev' && thisprev.className != 'actend') { return 0; }\n");
      fprintf(stdout, "    if (where == 'next' && thisnext.className != 'action') { return 0; }\n");
      fprintf(stdout, "    while (wispgoto(goto)) {\n");
      fprintf(stdout, "      console.log('goto ' + goto);\n");
      fprintf(stdout, "      thisprev = thiswisp.previousElementSibling;\n");
      fprintf(stdout, "      thisnext = thiswisp.nextElementSibling;\n");
      fprintf(stdout, "      if (where == 'prev' && !thisprev) { return -1; }\n");
      fprintf(stdout, "      if (where == 'next' && !thisnext) { return -1; }\n");
      fprintf(stdout, "      if (where == 'prev' && thisnext.className == 'action') { return 1; }\n");
      fprintf(stdout, "      if (where == 'next' && thisprev.className == 'actend') { return 1; }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return -1;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisppos(pos) {\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    var wispline = thiswisp.parentElement;\n");
      fprintf(stdout, "    if (!thisline || !thiswisp) { return false; }\n");
      fprintf(stdout, "    var thiswisppr = thiswisp.previousElementSibling;\n");
      fprintf(stdout, "    var thiswispnx = thiswisp.nextElementSibling;\n");
      fprintf(stdout, "    var thislinefc = thisline.firstElementChild;\n");
      fprintf(stdout, "    var thiswispfc = thiswisppr;\n");
      fprintf(stdout, "    var thiswispix = 0;\n");
      fprintf(stdout, "    while (thiswispfc) {\n"); // && thiswispfc.previousElementSibling) {\n");
      fprintf(stdout, "      thiswispix++;\n");
      fprintf(stdout, "      thiswispfc = thiswispfc.previousElementSibling;\n");
      fprintf(stdout, "    }\n");
//      fprintf(stdout, "    if (thiswispfc.className != 'lnum') { thiswispix++; }\n");
      fprintf(stdout, "    if (pos === undefined)\n");
      fprintf(stdout, "      { return (thisline != wispline) ? thiswispix : -1 - thiswispix; }\n");
      fprintf(stdout, "    if (pos < 0 && thislinefc) {\n");
      fprintf(stdout, "      if (thiswisp != thislinefc.nextElementSibling)\n");
      fprintf(stdout, "        { thisline.insertBefore(thiswisp, thislinefc.nextElementSibling); }\n");
      fprintf(stdout, "      return -2;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (pos >= 0 && thisline == wispline) {\n");
      fprintf(stdout, "      thiswispnx = thiswisp.nextElementSibling;\n"); // .firstElementChild;
      fprintf(stdout, "      if (!thiswispnx) { thiswispnx = thiswisp.previousElementSibling; }\n");
      fprintf(stdout, "      if (thiswispnx && thiswispnx.className != 'lnum') {\n");
      fprintf(stdout, "        wispline = thiswispnx;\n");
      fprintf(stdout, "        thiswispnx = thiswispnx.firstElementChild;\n");
      fprintf(stdout, "        thiswispix = 0;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    while (thiswispix > 0 && thiswispix > pos) {\n");
      fprintf(stdout, "      if (!thiswispnx) { thiswispnx = thiswisp; }\n");
      fprintf(stdout, "      else { thiswispnx = thiswispnx.previousElementSibling; }\n");
      fprintf(stdout, "      if (thiswispnx.className.substr(-4) != 'wisp')\n");
      fprintf(stdout, "        { thiswispix--; }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    while (thiswispnx && thiswispix < pos) {\n");
      fprintf(stdout, "      thiswispnx = thiswispnx.nextElementSibling;\n");
      fprintf(stdout, "      thiswispix++;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    wispline.insertBefore(thiswisp, thiswispnx);\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispleft(distance) {\n");
      fprintf(stdout, "    if (wispgotoaction('prev') == 0) {\n");
      fprintf(stdout, "      while (--distance >= 0)\n");
      fprintf(stdout, "        { wispgoto('tlth', false); }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    wispfocus();\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispright(distance) {\n");
      fprintf(stdout, "    if (wispgotoaction('next') == 0) {\n");
      fprintf(stdout, "      while (--distance >= 0)\n");
      fprintf(stdout, "        { wispgoto('trth', false); }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    wispfocus();\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var wispcountdown = { n: 0, f: null };\n");
      fprintf(stdout, "  var wispcleancolour = '#710';\n");
      fprintf(stdout, "  function wispspinner() {\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    var thismode = tabmode[inbosel];\n");
      fprintf(stdout, "    if (!thiswisp) { return; }\n");
      fprintf(stdout, "    if (copying || pasting) { return; }\n");
      fprintf(stdout, "    if (loading)\n");
      fprintf(stdout, "      { $$('loadframe').contentWindow.upkgo(); return; }\n");
      fprintf(stdout, "    iosend();\n");
      fprintf(stdout, "    var thislinesel = linesel[inbosel];\n");
      fprintf(stdout, "    wispii = (wispii + 1) %% 4;\n");
      fprintf(stdout, "    if (wispcountdown.n > 0) {\n");
      fprintf(stdout, "      wispcountdown.n--;\n");
      fprintf(stdout, "      if (wispcountdown.n == 0 && wispcountdown.f)\n");
      fprintf(stdout, "        { wispcountdown.f(); wispcountdown.f = null; }\n");
      fprintf(stdout, "    }\n");
//      fprintf(stdout, "    var wisptext = '<i style=\"color: ' + wispspan[wispen] + ';\">';\n");
      fprintf(stdout, "    var clni = -1;\n");
      fprintf(stdout, "    while (++clni < wispclean.length) {\n");
      fprintf(stdout, "      if (wispclean[clni][0] <= 0) {\n");
      fprintf(stdout, "        iocleanline(wispclean[clni][1], wispclean[clni][2]);\n");
      fprintf(stdout, "        wispmesscolour = wispcleancolour;\n");
      fprintf(stdout, "        wispclean.splice(clni, 1);\n");
      fprintf(stdout, "        clni--;\n");
      fprintf(stdout, "      } else { wispclean[clni][0] -= 1; }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (thislinesel == 0) {\n");
      fprintf(stdout, "      if (wispmesscolour != '') {\n");
//      fprintf(stdout, "        var wispbgcolour = (thismode == 1) ? '#fff' : '#017';\n");
      fprintf(stdout, "        var wisptext = '<span style=\"color: ' + wispmesscolour + ';\">';\n");
//      fprintf(stdout, "        wisptext += 'background-color: ' + wispbgcolour + ';\">';\n");
      fprintf(stdout, "        wisptext += wispspin[wispii] + '</span>';\n");
      fprintf(stdout, "        thiswisp.innerHTML = wisptext;\n");
      fprintf(stdout, "      } else { thiswisp.innerHTML = wispspin[wispii]; }\n");
      fprintf(stdout, "    } else if (thismode == 1) {\n");
      fprintf(stdout, "      var messcolour = wispmesscolour;\n");
      fprintf(stdout, "      if (thiswisp.parentElement == thisline)\n");
      fprintf(stdout, "        { messcolour = '#222'; }\n");
      fprintf(stdout, "      if (messcolour != '') {\n");
      fprintf(stdout, "        var wisptext = '<span style=\"color: #fff; ';\n");
      fprintf(stdout, "        wisptext += 'background-color: ' + messcolour + ';\">';\n");
      fprintf(stdout, "        wisptext += wispspin[wispii] + '</span>';\n");
      fprintf(stdout, "        thiswisp.innerHTML = wisptext;\n");
      fprintf(stdout, "      } else { thiswisp.innerHTML = wispspin[wispii]; }\n");
      fprintf(stdout, "    } else if (thismode == 0) {\n");
      fprintf(stdout, "      thiswisp.innerHTML = '';\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (wispmesscolour == wispcleancolour)\n");
      fprintf(stdout, "      { wispmesscolour = ''; }\n");
      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  var wispnewlinecount = 0;\n");
//      fprintf(stdout, "  function wispnewlineindex()\n");
//      fprintf(stdout, "  { ++wispnewlinecount; return 'newline' + wispnewlinecount.toString(); }\n");
      fprintf(stdout, "  function wispkey(letter) {\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    var wispline = thiswisp.parentElement;\n");
      fprintf(stdout, "    var thismode = tabmode[inbosel];\n");
      fprintf(stdout, "    if (!thisline || !thiswisp) { return; }\n");
      fprintf(stdout, "    if (thisline == wispline)\n");
      fprintf(stdout, "      { console.log('keyline'); return; }\n");
      fprintf(stdout, "    var wispclass = thiswisp.className;\n");
      fprintf(stdout, "    if (wispen == 'n' && wispclass != 'bluewisp') { return; }\n");
      fprintf(stdout, "    if (thismode != 1 && wispclass != 'bluewisp') { return; }\n");
      fprintf(stdout, "    var wisptype = thiswisp.className;\n");
      fprintf(stdout, "    if (wisptype == 'redwisp') { return; }\n");
      fprintf(stdout, "    var thiswisppr = thiswisp.previousElementSibling;\n");
      fprintf(stdout, "    var thiswispnx = thiswisp.nextElementSibling;\n");
      fprintf(stdout, "    if (wisptype == 'bluewisp') {\n");
      fprintf(stdout, "      if (letter == '[') {\n");
      fprintf(stdout, "        if (!thiswisppr) {\n");
      fprintf(stdout, "          var wispletlf = document.createElement('b');\n");
      fprintf(stdout, "          wispletlf.style.color = '#fff';\n");
      fprintf(stdout, "          wispletlf.style.backgroundColor = '#33f';\n");
      fprintf(stdout, "          wispletlf.innerHTML = '[';\n");
      fprintf(stdout, "          var wispletrg = document.createElement('b');\n");
      fprintf(stdout, "          wispletrg.style.color = '#33f';\n");
      fprintf(stdout, "          wispletrg.style.backgroundColor = '#fff';\n");
      fprintf(stdout, "          wispletrg.innerHTML = ']';\n");
      fprintf(stdout, "          thisline.insertBefore(wispletlf, thiswisp);\n");
      fprintf(stdout, "          thisline.insertBefore(wispletrg, thiswispnx);\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      } else if (letter == ']') {\n");
      fprintf(stdout, "        if (thiswispnx && thiswispnx.innerHTML == ']') {\n");
      fprintf(stdout, "          wispsubmittrigger();\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      } else {\n");
      fprintf(stdout, "        var wisplet = document.createElement('b');\n");
      fprintf(stdout, "        wisplet.style.color = '#fff';\n");
      fprintf(stdout, "        wisplet.style.backgroundColor = '#33f';\n");
      fprintf(stdout, "        wisplet.innerHTML = letter;\n");
      fprintf(stdout, "        wispline.insertBefore(wisplet, thiswisp);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    } else {\n");
      fprintf(stdout, "      var wisplet = document.createElement('b');\n");
      fprintf(stdout, "      wisplet.style.color = '#fc3';\n");
      fprintf(stdout, "      wisplet.style.backgroundColor = '#b22';\n");
      fprintf(stdout, "      wisplet.innerHTML = letter;\n");
      fprintf(stdout, "      wispline.insertBefore(wisplet, thiswisp);\n");
      fprintf(stdout, "      iosetmod(inbex, thisline, 1);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    wispfocus();\n");
      fprintf(stdout, "  }\n");
      // -----------------------------------------------------------------------------------
//      fprintf(stdout, "  var inboxdata = { rangesize: 0, range: [0, 0], numlines: 0, lines: {} };\n");
//      fprintf(stdout, "  function inboxline(lindex, wispisred) {\n");
//      fprintf(stdout, "    var ils = '';\n");
//      fprintf(stdout, "    var txttxt = inboxdata.lines['l' + lindex].txt;\n");
//      fprintf(stdout, "    var rtftxt = inboxdata.lines['l' + lindex].rtf;\n");
// later: linehead + linebuf + linewisp
//      fprintf(stdout, "    ils += '<b class=\"lnum\">' + lindex + '</b>';\n");
//      fprintf(stdout, "    ils += rtftxt;\n");
//      fprintf(stdout, "    if (lindex == inboxdata.numlines && txttxt.length == 0)\n");
//      fprintf(stdout, "      { ils += '<b id=\"line' + lindex + '=\" class=\"redwisp\"></b>'; }\n");
//      fprintf(stdout, "    else { ils += '<b id=\"line' + lindex + '=\" class=\"wisp\"></b>'; }\n");
//      fprintf(stdout, "    return ils;\n");
//      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  function wisptriggerview(fromini, toini) {\n");
//      fprintf(stdout, "  \n");
//      fprintf(stdout, "  \n");
      fprintf(stdout, "  function strstart(str, start, replace) {\n");
      fprintf(stdout, "    if (start == str.substr(0, start.length))\n");
      fprintf(stdout, "      { return replace + str.substr(start.length); }\n");
      fprintf(stdout, "    return str;\n");
      fprintf(stdout, "  }\n");
/*
      fprintf(stdout, "    if (str.charAt(1) == '/') {\n");
      fprintf(stdout, "      if (str.charAt(0) == '#')\n");
      fprintf(stdout, "        { str = 'http://' + str.substr(2); }\n");
      fprintf(stdout, "      else if (str.charAt(0) == '$')\n");
      fprintf(stdout, "        { str = 'https://' + str.substr(2); }\n");
      fprintf(stdout, "      else if (str.charAt(0) == '%')\n");
      fprintf(stdout, "        { str = '%s?' + str.substr(2); }\n", TABDATURL);
      fprintf(stdout, "      else if (str.charAt(0) == '~')\n");
      fprintf(stdout, "        { str = '%s?' + str.substr(2); }\n", TABURLURL);
      fprintf(stdout, "    }\n");
*/ // re-enable ^^ #/ $/ %/ ~/ = http https data file
      fprintf(stdout, "  function urltranslate(str, inbex, linum) {\n");
      fprintf(stdout, "    var oldstr = '@' + inbex + ',' + linum + ':' + str;\n");
      fprintf(stdout, "    var newstr = stringbasecode(oldstr);\n");
      fprintf(stdout, "    return '%s?+' + newstr;\n", TABDATURL);
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispgetopenbox(inbex) {\n");
      fprintf(stdout, "    var openbox = $$('in' + inbex + 'openbox');\n");
      fprintf(stdout, "    if (!openbox) {\n");
      fprintf(stdout, "      var tolinezero = $$('in' + inbex + 'ln0');\n");
      fprintf(stdout, "      if (!tolinezero) {\n");
      fprintf(stdout, "        ioaddinbox(inbex);\n");
      fprintf(stdout, "        tolinezero = $$('in' + inbex + 'ln0');\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      openbox = document.createElement('div');\n");
      fprintf(stdout, "      openbox.id = 'in' + inbex + 'openbox';\n");
      fprintf(stdout, "      openbox.className = 'openbox';\n");
      fprintf(stdout, "      var openboxframe = document.createElement('iframe');\n");
      fprintf(stdout, "      openboxframe.className = 'nul';\n");
      fprintf(stdout, "      var openboxlabel = document.createElement('div');\n");
      fprintf(stdout, "      openboxlabel.innerHTML = 'nul';\n");
      fprintf(stdout, "      openbox.innerHTML = '';\n");
      fprintf(stdout, "      tolinezero.appendChild(openbox);\n");
      fprintf(stdout, "      tolinezero.className = 'openline';\n");
      fprintf(stdout, "      openbox.appendChild(openboxframe);\n");
      fprintf(stdout, "      openbox.appendChild(openboxlabel);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return openbox;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispseektriggeropen(fromini, fromln, toini) {\n");
      fprintf(stdout, "    var fromlnel = $$('in' + fromini + 'ln' + fromln);\n");
      fprintf(stdout, "    var fromtext = (fromlnel) ? iolinestring(fromlnel) : '';\n");
// ^^ limit to actual selection .. split into array of []()[]()[]
// [The Title]: [#/db.db/1234] iframe
// { type: '[]', str: 'The Title' }, { type: ':', str: ': ' }
// , { type: '[]', str: '#/db.db/1234' }
// [coverart]: [/dir/to/art.jpg] img .. nay, url, iframe
// [.soundtrack]: [The Soundtrack]
      fprintf(stdout, "    var fts = [{ type: '[]', str: fromtext }];\n");
      fprintf(stdout, "    var openbox = wispgetopenbox(toini);\n");
// spacebar = default key ..... open>6  open<5 open 5 open.5 . = default
      fprintf(stdout, "    var fti = -1;\n");
      fprintf(stdout, "    while (++fti < fts.length) {\n");
      fprintf(stdout, "      var ftvo = fts[fti].str;\n");
      fprintf(stdout, "      var ftvn = urltranslate(ftvo, fromini, fromln);\n");
      fprintf(stdout, "      if (ftvn != ftvo) {\n");
      fprintf(stdout, "        var obf = openbox.firstElementChild;\n");
      fprintf(stdout, "        try { obf.src = ftvn; obf.className = 'act'; }\n");
      fprintf(stdout, "        catch (e) { obf.className = 'err'; }\n");
      fprintf(stdout, "        var obl = openbox.lastElementChild;\n");
      fprintf(stdout, "        obl.innerHTML = ftvo;\n");
      fprintf(stdout, "        obl.className = obf.className;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function seektriggeropen() {\n");
      fprintf(stdout, "    wispseektriggeropen(seekinbox, seeklinum, seektarget);\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisptriggeropen(fromini, toini) {\n");
      fprintf(stdout, "    var fromln = linesel[fromini];\n");
      fprintf(stdout, "    if (fromln < 0) { return; }\n");
      fprintf(stdout, "    wispseektriggeropen(fromini, fromln, toini);\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wisptriggerload(fromini, toini) {\n");
      fprintf(stdout, "    var openbox = wispgetopenbox(toini);\n");
      fprintf(stdout, "    var openifr = openbox.firstElementChild;\n");
      fprintf(stdout, "    var openlbl = openbox.lastElementChild;\n");
      fprintf(stdout, "    var oel = lineid[fromini];\n");
      fprintf(stdout, "    var otx = iolinestring(oel);\n");
      fprintf(stdout, "    var oti = -1;\n");
      fprintf(stdout, "    while (++oti < otx.length) {\n");
      fprintf(stdout, "      var occ = otx.charCodeAt(oti);\n");
      fprintf(stdout, "    }\n"); // todo: translate any bad chars - / to -, - to : (cannot open R:)
      fprintf(stdout, "    openifr.src = '%s?' + otx;\n", TABURLURL); // open as text for now
//      fprintf(stdout, "    openifr.src = '/~@/load?target=';\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispapplytriggers() {\n");
//      fprintf(stdout, "    var ini = inbosel;\n");
//      fprintf(stdout, "    var ino = ionextinbox('r');\n");
//      fprintf(stdout, "    while (++ini <= 9) {\n");
//      fprintf(stdout, "    var inname = 'in' + inbosel;\n");
//      fprintf(stdout, "    var trigbox = $$(inname + 'trigbox');\n");
      fprintf(stdout, "    var trigbox = $$('trigbox');\n");
      fprintf(stdout, "    if (trigbox) {\n");
      fprintf(stdout, "      var tt = trigbox.innerHTML;\n");
      fprintf(stdout, "      var tti = -1;\n");
      fprintf(stdout, "      var ttr = [0, 0];\n");
      fprintf(stdout, "      while (++tti < tt.length) {\n");
      fprintf(stdout, "        if (tt.charAt(tti) == '[')\n");
      fprintf(stdout, "          { ttr[0] = tti; }\n");
      fprintf(stdout, "        if (tt.charAt(tti) == ']') {\n");
      fprintf(stdout, "          ttr[1] = tti;\n");
      fprintf(stdout, "          var ttx = tt.substr(ttr[0], ttr[1] - ttr[0] + 1);\n");
      fprintf(stdout, "          var tnb = ionamebreak(ttx);\n");
      fprintf(stdout, "          if (tnb[0] == '[' && tnb[2].substr(0, 1) == ':') {\n");
      fprintf(stdout, "            var tnv = ionamebreak(tnb[2]);\n");
      fprintf(stdout, "            if (tnv[0] == ':open ' && tnv[2] == ']')\n");
      fprintf(stdout, "              { wisptriggeropen(tnb[1], tnv[1]); }\n");
      fprintf(stdout, "            else if (tnv[0] == ':load ' && tnv[2] == ']')\n");
      fprintf(stdout, "              { wisptriggerload(tnb[1], tnv[1]); }\n");
      fprintf(stdout, "            else if (tnv[0] == ':save ' && tnv[2] == ']')\n");
      fprintf(stdout, "              { wisptriggersave(tnb[1], tnv[1]); }\n");
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function strchar(str, fromchar, tochar) {\n");
      fprintf(stdout, "    var haschar = str.indexOf(fromchar);\n");
      fprintf(stdout, "    while (haschar >= 0) {\n");
      fprintf(stdout, "      var strl = str.substr(0, haschar);\n");
      fprintf(stdout, "      var strr = str.substr(haschar + fromchar.length);\n");
      fprintf(stdout, "      str = strl + tochar + strr;\n");
      fprintf(stdout, "      haschar = str.indexOf(fromchar);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return str;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispsubmittrigger() {\n");
      fprintf(stdout, "    var trigline = $$('in' + inbosel + 'ln0');\n");
      fprintf(stdout, "    var trigtext = iolinestring(trigline);\n");
      fprintf(stdout, "    ioclearline(trigline);\n");
      fprintf(stdout, "    if (trigtext.substr(0, 1) != '[') { return; }\n");
      fprintf(stdout, "    if (trigtext.substr(-1) != ']') { return; }\n");
      fprintf(stdout, "    var trigword = trigtext.substr(1, trigtext.length - 2);\n");
      fprintf(stdout, "    if (trigword.indexOf('[') != -1) { return; }\n");
      fprintf(stdout, "    if (trigword.indexOf(']') != -1) { return; }\n");
      fprintf(stdout, "    trigword = strchar(trigword, ' ', ',');\n");
      fprintf(stdout, "    ioopen('@' + trigword);\n"); // cmd pre-base64
//      fprintf(stdout, "    var trigbox = $$('trigbox');\n");

//      fprintf(stdout, "    var trigbox = $$('in' + inbosel + 'trigbox');\n");
//      fprintf(stdout, "    var totext = '';\n");
//      fprintf(stdout, "    if (!trigbox) {\n");
//      fprintf(stdout, "      trigbox = document.createElement('div');\n");
//      fprintf(stdout, "      trigbox.id = 'in' + inbosel + 'trigbox';\n");
//      fprintf(stdout, "      trigbox.className = 'trigbox';\n");
//      fprintf(stdout, "      totext = trigbox.innerHTML = '';\n");
//      fprintf(stdout, "      trigline.appendChild(trigbox);\n");
//      fprintf(stdout, "    } else { totext = trigbox.innerHTML; }\n");

/*
      fprintf(stdout, "    var totext = trigbox.innerHTML;\n");
      fprintf(stdout, "    var tnb = ionamebreak(trigword);\n");
      fprintf(stdout, "    if (tnb[0] == '' && tnb[2] == '' && trigword != '')\n");
      fprintf(stdout, "      { iosetinbox(tnb[1]); return; }\n");
      fprintf(stdout, "    if (tnb[0] != '' || tnb[2].substr(0, 1) != ':')\n");
      fprintf(stdout, "      { trigword = inbosel + ':' + trigword; }\n");
      fprintf(stdout, "    trigtext = '[' + trigword + ']';\n");
      fprintf(stdout, "    tnb = ionamebreak(trigword);\n");
      fprintf(stdout, "    var trigtextpos = totext.indexOf(trigtext);\n");
      fprintf(stdout, "    if (trigtextpos != -1) {\n");
      fprintf(stdout, "      var totextl = totext.substr(0, trigtextpos);\n");
      fprintf(stdout, "      var totextr = totext.substr(trigtextpos + trigtext.length);\n");
      fprintf(stdout, "      if (totextr.substr(0, 4) == '<br>')\n");
      fprintf(stdout, "        { totextr = totextr.substr(4); }\n");
      fprintf(stdout, "      totext = totextl + totextr;\n");
      fprintf(stdout, "    } else {\n");
      fprintf(stdout, "      if (trigword == 'load') {\n");
      fprintf(stdout, "        bodydrag();\n");
      fprintf(stdout, "      } else {\n");
      fprintf(stdout, "        if (totext.substr(-1) == ']')\n");
      fprintf(stdout, "          { totext += '<br>'; }\n");
      fprintf(stdout, "        totext += trigtext;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    trigbox.innerHTML = totext;\n");
*/
      fprintf(stdout, "  }\n");
//--------------------------------------------------------------------------
      fprintf(stdout, "  function filesettag(ln0val) {\n");
      fprintf(stdout, "    var ln0val0 = ln0val.substr(0, 1);\n");
      fprintf(stdout, "    if (ln0val0 != '.') { return false; }\n");
      fprintf(stdout, "    return false;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function filemeldto(ln0val) {\n");
      fprintf(stdout, "    var ln0val0 = ln0val.substr(0, 1);\n");
      fprintf(stdout, "    if (ln0val0 != '#') { return false; }\n");
      fprintf(stdout, "    return false;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function filejumpto(ln0val) {\n");
      fprintf(stdout, "    var ls0 = ionamebreak(ln0val);\n");
      fprintf(stdout, "    var lsel = linesel[inbosel];\n");
      fprintf(stdout, "    if (ls0[0] == '=') {\n");
      fprintf(stdout, "      highlightline(inbosel, ls0[1]);\n");
      fprintf(stdout, "      wispswitch(); return true;\n");
      fprintf(stdout, "    } else if (ls0[0] == '=+') {\n");
      fprintf(stdout, "      highlightline(inbosel, lsel + ls0[1]);\n");
      fprintf(stdout, "      wispswitch(); return true;\n");
      fprintf(stdout, "    } else if (ls0[0] == '=-') {\n");
      fprintf(stdout, "      highlightline(inbosel, 0 - ls0[1]);\n");
      fprintf(stdout, "      wispswitch(); return true;\n");
      fprintf(stdout, "    } else { return false; }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function fileopento(ln0val) {\n");
      fprintf(stdout, "    var ls0 = ionamebreak(ln0val);\n");
      fprintf(stdout, "    if (ls0[0] == '+') {\n");
      fprintf(stdout, "      ioclearinbox(inbosel);\n");
      fprintf(stdout, "      ioaddlines(inbosel, ls0[1], -(ls0[1] + 25));\n"); // CHECK THIS
      fprintf(stdout, "      iohandlequeue(inbosel);\n");
      fprintf(stdout, "      return true;\n");
      fprintf(stdout, "    } else { return false; }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function filesearch(ln0val) {\n");
      fprintf(stdout, "    var ln0val0 = ln0val.substr(0, 1);\n");
      fprintf(stdout, "    if (ln0val0 != '/') { return false; }\n");
      fprintf(stdout, "    return false;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function fileopenin(ln0val) {\n");
      fprintf(stdout, "    var ls0 = ionamebreak(ln0val);\n");
      fprintf(stdout, "    if (ls0[0] != '>') { return false; }\n");
      fprintf(stdout, "    iosetinbox(ls0[1]);\n");
      fprintf(stdout, "    highlightline(ls0[1], 0);\n");
      fprintf(stdout, "    wispswitch();\n");
      fprintf(stdout, "    var lsdelim = ls0[2].substr(0, 1);\n");
      fprintf(stdout, "    if (lsdelim != ':') { return true; }\n");
      fprintf(stdout, "    pasting = true;\n");
      fprintf(stdout, "    $$('pastext').value = ls0[2].substr(1);\n");
      fprintf(stdout, "    pastefocus();\n");
      fprintf(stdout, "    return true;\n");
      fprintf(stdout, "  }\n");
//--------------------------------------------------------------------------
      fprintf(stdout, "  function wispopen(direction) {\n");
      fprintf(stdout, "    var thisinbox = inbosel;\n");
      fprintf(stdout, "    if (thisinbox >= 5 && thisinbox <= 9) {\n");
      fprintf(stdout, "      var ibn = [5, 6];\n");
      fprintf(stdout, "      if (direction == 'l') { ibn = [6, 5]; }\n");
      fprintf(stdout, "      if (direction == 'r') { ibn = [5, 6]; }\n");
      fprintf(stdout, "      if (direction == 'u') { ibn = [8, 7]; }\n");
      fprintf(stdout, "      if (direction == 'd') { ibn = [7, 8]; }\n");
      fprintf(stdout, "      if (direction == 'h') { ibn = [0, thisinbox]; }\n");
      fprintf(stdout, "      if (direction == 't') { ibn = [0, thisinbox]; }\n");
      fprintf(stdout, "      if (ibn[0] > 0)\n");
      fprintf(stdout, "        { iosetinboxrangefrominbox(ibn[0], thisinbox); }\n");
      fprintf(stdout, "      iosetinbox(ibn[1]);\n");
      fprintf(stdout, "      if (ibn[0] > 0) {\n");
      fprintf(stdout, "        iosetinbox(ibn[0]);\n");
      fprintf(stdout, "        highlightwhenadded(ibn[0], linesel[thisinbox], 0);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    } else if (thisinbox >= 1 && thisinbox <= 4) {\n");
      fprintf(stdout, "      \n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    var nextinbox = thisinbox;\n");
      fprintf(stdout, "    if (direction != 'h')\n");
      fprintf(stdout, "      { nextinbox = ionextinbox(direction); }\n");
      fprintf(stdout, "    if (nextinbox > 0) {\n");
      fprintf(stdout, "      wisptriggeropen(thisinbox, nextinbox);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispaddline(fillmode) {\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    var wispline = thiswisp.parentElement;\n");
      fprintf(stdout, "    var thismode = tabmode[inbosel];\n");
      fprintf(stdout, "    if (!thisline || !thiswisp) { return; }\n");
//      fprintf(stdout, "    if (fillmode != 'p' && wispen == 'n') { return; }\n");
      fprintf(stdout, "    var wispclass = thiswisp.className;\n");
      fprintf(stdout, "    if (wispen == 'n' && wispclass != 'bluewisp') { return; }\n");
      fprintf(stdout, "    if (thismode != 1 && wispclass != 'bluewisp') { return; }\n");
      fprintf(stdout, "    if (!ioqueuelist[inbex] || ioqueuelist[inbex].length > 0) { return; }\n");
      fprintf(stdout, "    if (wispline == thisline) { return; }\n");
      fprintf(stdout, "    var fromlineel = thisline;\n");
      fprintf(stdout, "    var inb = ionamebreak(fromlineel.id);\n");
      fprintf(stdout, "    if (inb[0] != 'in') { return; }\n");
      fprintf(stdout, "    var insfx = 0;\n");
      fprintf(stdout, "    if (inb[0] == '.') {\n");
      fprintf(stdout, "      var isb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "      insfx = isb[1];\n");
      fprintf(stdout, "      inb[2] = isb[2];\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    var insuffix = (insfx == 0) ? '' : '.' + insfx;\n");
      fprintf(stdout, "    var lnb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "    if (lnb[0] != 'ln') { return; }\n");
      fprintf(stdout, "    var newlineindex = lnb[1] + 1;\n");
      fprintf(stdout, "    var nextsibling = fromlineel.nextSibling;\n");
      fprintf(stdout, "    if (wispclass == 'redwisp') {\n");
      fprintf(stdout, "      wispgoto('peol', false);\n");
      fprintf(stdout, "      wispaddline(fillmode);\n");
      fprintf(stdout, "      return;\n");
      fprintf(stdout, "    } else if (wispclass == 'bluewisp') {\n");
//      fprintf(stdout, "      wispgoto('nsol');\n");
      fprintf(stdout, "      var ln0val = iolinestring(thisline);\n");
      fprintf(stdout, "      var ln0val0 = ln0val.substr(0, 1);\n");
      fprintf(stdout, "      if (ln0val0 == '.') {\n"); // tag
      fprintf(stdout, "        if (filesettag(ln0val))\n");
      fprintf(stdout, "          { ioclearline(thisline); } return;\n");
      fprintf(stdout, "      } else if (ln0val0 == '#') {\n");
      fprintf(stdout, "        if (filemeldto(ln0val))\n");
      fprintf(stdout, "          { ioclearline(thisline); } return;\n");
      fprintf(stdout, "      } else if (ln0val0 == '=') {\n");
      fprintf(stdout, "        if (filejumpto(ln0val))\n");
      fprintf(stdout, "          { ioclearline(thisline); } return;\n");
      fprintf(stdout, "      } else if (ln0val0 == '+') {\n");
      fprintf(stdout, "        if (fileopento(ln0val))\n");
      fprintf(stdout, "          { ioclearline(thisline); } return;\n");
      fprintf(stdout, "      } else if (ln0val0 == '/') {\n");
      fprintf(stdout, "        if (filesearch(ln0val))\n");
      fprintf(stdout, "          { ioclearline(thisline); } return;\n");
      fprintf(stdout, "      } else if (ln0val0 == '>') {\n");
      fprintf(stdout, "        if (fileopenin(ln0val))\n");
      fprintf(stdout, "          { ioclearline(thisline); } return;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      if (wispen == 'n') { return; }\n");
      fprintf(stdout, "      if (thismode != 1) { return; }\n");
      fprintf(stdout, "      pasting = true;\n");
      fprintf(stdout, "      $$('pastext').value = ln0val;\n");
      fprintf(stdout, "      fillmode = 'p';\n");
//      fprintf(stdout, "      linesel[inbosel] = 1;\n");
//      fprintf(stdout, "      rehighlightline(inbosel);\n");
//      fprintf(stdout, "      wispaddline();\n");
//      fprintf(stdout, "      pastefocus();\n");
//      fprintf(stdout, "      highlightprevline(1);\n");
//      fprintf(stdout, "      return;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    var inbname = 'in' + inb[1] + insuffix;\n");
      fprintf(stdout, "    var dline = $$(inbname).lastElementChild;\n");
      fprintf(stdout, "    var ind = ionamebreak(dline.id);\n");
      fprintf(stdout, "    var lnd = ionamebreak(ind[2]);\n");
//      fprintf(stdout, "    var dlineid = inbname + 'ln' + dli;\n");
      fprintf(stdout, "    var dwisp = $$(dline.id + '=');\n");
      fprintf(stdout, "    var dli = (lnd[0] == 'ln') ? lnd[1] : 0;\n");
//      fprintf(stdout, "    while (++dli > 0) {\n");
//      fprintf(stdout, "      var thislineel = $$(inbname + 'ln' + dli);\n");
//      fprintf(stdout, "      if (!thislineel) { break; }\n");
//      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (dli == inbexranges[inb[1]][insfx].limit) {\n");
      fprintf(stdout, "      console.log('lastlinefly');\n");
      fprintf(stdout, "      dline.className = 'fly';\n");
      fprintf(stdout, "      dline.firstChild.innerHTML = '^' + dli;\n");
      fprintf(stdout, "      dwisp.id = dline.id + '=~';\n");
      fprintf(stdout, "      dwisp.className = 'redwisp';\n");
      fprintf(stdout, "      dline.id = dline.id + '~';\n");
      fprintf(stdout, "      iopageflight(inb[1], 0);\n"); // if () { ... }
      fprintf(stdout, "      wispclean.push([6, inb[1], dli]);\n");
      fprintf(stdout, "    }\n"); // ^ remove bottom line
//      fprintf(stdout, "    $$(inbname).removeChild(dline);\n");
      fprintf(stdout, "    dli++;\n"); // reuse dli
      fprintf(stdout, "    while (--dli >= newlineindex) {\n");
      fprintf(stdout, "      var dlni = dli + 1;\n");
      fprintf(stdout, "      var thislineel = $$(inbname + 'ln' + dli);\n");
      fprintf(stdout, "      if (thislineel) {\n");
      fprintf(stdout, "        thislineel.id = inbname + 'ln' + dlni;\n");
      fprintf(stdout, "        thislineel.firstChild.innerHTML = '' + dlni;\n");
      fprintf(stdout, "        var thiswispel = $$(inbname + 'ln' + dli + '=');\n");
      fprintf(stdout, "        if (thiswispel)\n");
      fprintf(stdout, "          { thiswispel.id = inbname + 'ln' + dlni + '='; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n"); // ^ increment line numbers
//      fprintf(stdout, "    var newlinedata = '';\n");
      fprintf(stdout, "    var newlineid = inbname + 'ln' + newlineindex;\n");
      fprintf(stdout, "    var newlineel = document.createElement('div');\n");
      fprintf(stdout, "    newlineel.id = newlineid;\n");
      fprintf(stdout, "    var nlnum = '<b class=\"lnum\">+' + newlineindex + '</b>';\n");
      fprintf(stdout, "    var nlwsp = '<b id=\"' + newlineid + '=\" class=\"wisp\"></b>';\n");
      fprintf(stdout, "    newlineel.innerHTML = nlnum + '<div class=\"line\">' + nlwsp + '</div>';\n");
// add new chars after wisp since they will be sent to the server and refreshed
//      fprintf(stdout, "    newlineel.innerHTML = inboxline(newlineindex, true);\n");
//      fprintf(stdout, "    newlineel.firstElementChild.innerHTML = '+' + newlineindex;\n");
      fprintf(stdout, "    $$(inbname).insertBefore(newlineel, nextsibling);\n");
      fprintf(stdout, "    newlineel.onmouseover = nextsibling.onmouseover;\n");
      fprintf(stdout, "    newlineel.onmouseout = nextsibling.onmouseout;\n");
      fprintf(stdout, "    newlineel.onmousedown = nextsibling.onmousedown;\n");
      fprintf(stdout, "    newlineel.onmouseup = nextsibling.onmouseup;\n");
//      fprintf(stdout, "    highlightnextline(1);\n");
      fprintf(stdout, "    wispgoto('nsol', false);\n");
      fprintf(stdout, "    var nlwisp = $$(newlineid + '=');\n");
      fprintf(stdout, "    var nlline = nlwisp.parentElement;\n");
      fprintf(stdout, "    if (fillmode == 's') {\n");
      fprintf(stdout, "      while (thiswisp.nextElementSibling)\n");
      fprintf(stdout, "        { nlline.insertBefore(thiswisp.nextElementSibling, nlwisp); }\n");
      fprintf(stdout, "    } else if (fillmode == 'e') {\n");
      fprintf(stdout, "    } else if (fillmode == 'p') {\n");
      fprintf(stdout, "      if (pasting) { pastefocus(); }\n");
//      fprintf(stdout, "      highlightnextline(1);\n");
      fprintf(stdout, "    }\n"); // ^ key in from paste buffer
//      fprintf(stdout, "    if (!nextsibling)\n");
//      fprintf(stdout, "      { highlightprevline(1); }\n");
//      fprintf(stdout, "    else {0- ==  highlightnextline(1); }\n");
  //    fprintf(stdout, "    ioqueuemods(inbex);\n");
//      fprintf(stdout, "    ioqueuelist.push(newlineel);\n");
//      fprintf(stdout, "    ioqueuelist.push(fromlineel);\n");
      fprintf(stdout, "    iosetmod(inbex, newlineel, 1);\n");
      fprintf(stdout, "    if (lnb[1] != 0)\n"); // ... fromlineel ?
      fprintf(stdout, "      { iosetmod(inbex, fromlineel, 1);\n");
      fprintf(stdout, "        console.log('save from line ' + lnb[1] + '...'); }\n");
      fprintf(stdout, "    else { console.log('save from line 0...'); }\n");
      fprintf(stdout, "    ioqueuemods(inbex);\n");
//      fprintf(stdout, "    wispswitch();\n");
      fprintf(stdout, "    iohandlequeue(inbex);\n");
      fprintf(stdout, "  }\n");
/* old line renaming code .. obsolete
      fprintf(stdout, "  function iofilerename(oldname, newname) {\n");
      fprintf(stdout, "    var lix = 0;\n");
      fprintf(stdout, "    while (++lix > 0) {\n");
      fprintf(stdout, "      var lid = $$(oldname + lix);\n");
      fprintf(stdout, "      if (!lid) { break; }\n");
      fprintf(stdout, "      else {\n");
      fprintf(stdout, "        lid.id = newname + lix;\n");
      fprintf(stdout, "        var wid = $$(oldname + lix + '=');\n");
      fprintf(stdout, "        if (wid) { wid.id = newname + lix + '='; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
*/
      fprintf(stdout, "  function ioaddinbox(inbex, fromnode) {\n");
      fprintf(stdout, "    if (inbex >= inbexpos.length) { return; }\n");
      fprintf(stdout, "    var inname = 'in' + inbex;\n");
      fprintf(stdout, "    var innext = 'in' + (inbex + 1);\n");
      fprintf(stdout, "    var previnbox = $$(inname);\n");
      fprintf(stdout, "    var nextinbox = $$(innext);\n");
      fprintf(stdout, "    var newinbix = inbexranges[inbex].length;\n");
      fprintf(stdout, "    if (previnbox) {\n");
      fprintf(stdout, "      var inewname = 'in' + inbex + '.' + newinbix;\n");
      fprintf(stdout, "      var iln = -1;\n");
      fprintf(stdout, "      while (++iln >= 0) {\n");
      fprintf(stdout, "        var lnname = inname + 'ln' + iln;\n");
      fprintf(stdout, "        var lnewname = inewname + 'ln' + iln;\n");
      fprintf(stdout, "        if (!$$(lnname)) { break; }\n");
      fprintf(stdout, "        else {\n");
      fprintf(stdout, "          $$(lnname).id = lnewname;\n");
      fprintf(stdout, "          $$(lnname + '=').id = lnewname + '=';\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      previnbox.id = inewname;\n");
      fprintf(stdout, "      previnbox.className = 'eth';\n");
      fprintf(stdout, "      var prevpagerange = inbexranges[inbex].shift();\n");
      fprintf(stdout, "      inbexranges[inbex].push(prevpagerange);\n");
      fprintf(stdout, "      var ili = -1;\n");
      fprintf(stdout, "      while (++ili < newinbix) {\n");
      fprintf(stdout, "        var inilbox = $$('in' + inbex + '.' + (ili + 1));\n");
      fprintf(stdout, "        if (inilbox) {\n");
      fprintf(stdout, "          inbexranges[inbex][ili].pos[0] += inbexpos[inbex][4][0];\n");
      fprintf(stdout, "          inbexranges[inbex][ili].pos[1] += inbexpos[inbex][4][1];\n");
      fprintf(stdout, "          inbexranges[inbex][ili].pos[2] += inbexpos[inbex][4][2];\n");
      fprintf(stdout, "          inbexranges[inbex][ili].pos[3] += inbexpos[inbex][4][3];\n");
      fprintf(stdout, "          inilbox.style.left = inbexranges[inbex][ili].pos[0] + '%';\n");
      fprintf(stdout, "          inilbox.style.right = inbexranges[inbex][ili].pos[1] + '%';\n");
      fprintf(stdout, "          inilbox.style.top = inbexranges[inbex][ili].pos[2] + '%';\n");
      fprintf(stdout, "          inilbox.style.bottom = inbexranges[inbex][ili].pos[3] + '%';\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    var nextsibling = (nextinbox) ? nextinbox : null;\n");
      fprintf(stdout, "    var newinbox = document.createElement('div');\n");
      fprintf(stdout, "    newinbox.id = inname;\n");
      fprintf(stdout, "    newinbox.className = 'off';\n");
      fprintf(stdout, "    newinbox.innerHTML = '';\n");
      fprintf(stdout, "    var thispagerange = { start: 0, limit: 0, pos: [0, 0, 0, 0] };\n");
      fprintf(stdout, "    thispagerange.pos[0] = inbexpos[inbex][0];\n");
      fprintf(stdout, "    thispagerange.pos[1] = inbexpos[inbex][1];\n");
      fprintf(stdout, "    thispagerange.pos[2] = inbexpos[inbex][2];\n");
      fprintf(stdout, "    thispagerange.pos[3] = inbexpos[inbex][3];\n");
      fprintf(stdout, "    inbexranges[inbex].unshift(thispagerange);\n");
      fprintf(stdout, "    newinbox.style.left = inbexranges[inbex][0].pos[0] + '%';\n");
      fprintf(stdout, "    newinbox.style.right = inbexranges[inbex][0].pos[1] + '%';\n");
      fprintf(stdout, "    newinbox.style.top = inbexranges[inbex][0].pos[2] + '%';\n");
      fprintf(stdout, "    newinbox.style.bottom = inbexranges[inbex][0].pos[3] + '%';\n");
      fprintf(stdout, "    $$('inbox').insertBefore(newinbox, nextsibling);\n");
      fprintf(stdout, "    var linezeroel = document.createElement('div');\n");
//      fprintf(stdout, "    var linezerolabel = '&nbsp;';\n");
      fprintf(stdout, "    linezeroel.id = 'in' + inbex + 'ln0';\n");
      fprintf(stdout, "    linezeroel.className = 'openline';\n"); // 'linezero';\n");
      fprintf(stdout, "    var wispzeroel = document.createElement('b');\n");
      fprintf(stdout, "    wispzeroel.id = 'in' + inbex + 'ln0=';\n");
      fprintf(stdout, "    wispzeroel.className = 'bluewisp';\n");
//      fprintf(stdout, "    var nlc = '<b class=\"lnum\">' + linezerolabel + '</b>';\n");
//      fprintf(stdout, "    var nlc = '<b id=\"' + linezeroel.id + '=\" class=\"bluewisp\"></b>';\n");
//      fprintf(stdout, "    linezeroel.innerHTML = nlc;\n");
      fprintf(stdout, "    linezeroel.appendChild(wispzeroel);\n");
      fprintf(stdout, "    $$('in' + inbex).insertBefore(linezeroel, null);\n");
      fprintf(stdout, "    if (inbosel == inbex) {\n");
      fprintf(stdout, "      pagesel[inbosel] = inbexranges[inbex].length;\n");
      fprintf(stdout, "      linesel[inbosel] = 0;\n");
//      fprintf(stdout, "      inbexranges[inbosel].sel[pagesel[inbosel]] = 0;\n");
      fprintf(stdout, "      lineid[inbosel] = linezeroel;\n");
      fprintf(stdout, "      wispid[inbosel] = wispzeroel;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  ioinboxminzindex = 11;\n");
      fprintf(stdout, "  function iosetinboxpage(inbex, pagex) {\n");
      fprintf(stdout, "    var thatbox = $$('in' + inbex);\n");
      fprintf(stdout, "    if (thatbox) {\n");
      fprintf(stdout, "      var inpglst = inbexranges[inbex];\n");
      fprintf(stdout, "      var pgzindex = ioinboxminzindex;\n");
      fprintf(stdout, "      var thatpage = thatbox;\n");
      fprintf(stdout, "      var ipi = 0;\n");
      fprintf(stdout, "      while (++ipi < inpglst.length) {\n");
      fprintf(stdout, "        if (ipi == pagex) { break; }\n");
      fprintf(stdout, "        thatpage = $$('in' + inbex + '.' + ipi);\n");
      fprintf(stdout, "        if (thatpage) {\n");
      fprintf(stdout, "          thatpage.className = 'eth';\n");
      fprintf(stdout, "          thatpage.style.zIndex = pgzindex;\n");
      fprintf(stdout, "          pgzindex++;\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      ipi = inpglst.length + 1;\n");
      fprintf(stdout, "      while (--ipi > 0) {\n");
      fprintf(stdout, "        if (ipi != inpglst.length) {\n");
      fprintf(stdout, "          thatpage = $$('in' + inbex + '.' + ipi);\n");
      fprintf(stdout, "        } else { thatpage = thatbox; }\n");
      fprintf(stdout, "        if (pagex == -1) {\n");
      fprintf(stdout, "          thatpage.className = 'off';\n");
      fprintf(stdout, "        } else if (pagex == 0) {\n");
      fprintf(stdout, "          if (ipi == 0) {\n");
      fprintf(stdout, "            thatpage.className = 'vis';\n");
      fprintf(stdout, "            thatpage.style.zIndex = pgzindex;\n");
      fprintf(stdout, "          } else { thatpage.className = 'off'; }\n");
      fprintf(stdout, "        } else if (ipi == pagex) {\n");
      fprintf(stdout, "          thatpage.className = 'act';\n");
      fprintf(stdout, "          thatpage.style.zIndex = pgzindex;\n");
      fprintf(stdout, "          break;\n");
      fprintf(stdout, "        } else {\n");
      fprintf(stdout, "          thatpage.className = 'eth';\n");
      fprintf(stdout, "          thatpage.style.zIndex = pgzindex;\n");
      fprintf(stdout, "          pgzindex++;\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iosetinbox(inbex) {\n");
      fprintf(stdout, "    var thisbox = $$('in' + inbex);\n");
      fprintf(stdout, "    var prevbox = $$('in' + inbosel);\n");
      fprintf(stdout, "    if (thisbox) {\n");
      fprintf(stdout, "      if (prevbox) {\n");
      fprintf(stdout, "        if (prevbox.className == 'act')\n");
      fprintf(stdout, "          { prevbox.className = 'vis'; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      var incompat = inbexpos[inbex][5];\n");
      fprintf(stdout, "      var ini = -1;\n");
      fprintf(stdout, "      while (++ini < incompat.length)\n");
      fprintf(stdout, "        { iosetinboxpage(incompat[ini], -1); }\n");
      fprintf(stdout, "      if (inbex == 0)\n");
      fprintf(stdout, "        { commboxesdisplay('block'); }\n");
      fprintf(stdout, "      else { commboxesdisplay('none'); }\n");
      fprintf(stdout, "      if (thisbox.className != 'tab')\n");
      fprintf(stdout, "        { thisbox.className = 'act'; }\n");
      fprintf(stdout, "      inbosel = inbex;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    wispswitch();\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function ionextinbox(direction) {\n");
      fprintf(stdout, "    if (!direction) { direction = 'r'; }\n");
      fprintf(stdout, "    var thisbox = $$('in' + inbosel);\n");
      fprintf(stdout, "    if (thisbox) {\n");
      fprintf(stdout, "      var lnk = inbexlinks[inbosel][direction];\n");
      fprintf(stdout, "      if (direction == 't') { return lnk[0]; }\n");
      fprintf(stdout, "      var lni = -1;\n");
      fprintf(stdout, "      while (++lni < lnk.length) {\n");
      fprintf(stdout, "        var thatbox = $$('in' + lnk[lni]);\n");
      fprintf(stdout, "        if (thatbox && thatbox.className == 'vis')\n");
      fprintf(stdout, "          { return lnk[lni]; break; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      return 0;\n"); // ? - lnkdef;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return 0;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var thatprevline = null;\n");
      fprintf(stdout, "  function ioaddlinegroup(inbex, inpage, start, length, limit) {\n");
      fprintf(stdout, "    var insuffix = (inpage == 0) ? '' : '.' + inpage;\n");
      fprintf(stdout, "    var thisname = 'in' + inbex + insuffix;\n");
      fprintf(stdout, "    var thisbox = $$(thisname);\n");
      fprintf(stdout, "    var continuing = 0;\n");
      fprintf(stdout, "    var unlimited = 0;\n");
      fprintf(stdout, "    if (limit < 0) {\n");
      fprintf(stdout, "      limit = 0 - limit;\n");
      fprintf(stdout, "      unlimited = 1;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (length < 0) {\n"); // continuing .. no new box
      fprintf(stdout, "      length = 0 - length;\n");
      fprintf(stdout, "      continuing = 1;\n"); // no range change ..
      fprintf(stdout, "      if (unlimited == 1) {\n");
      fprintf(stdout, "        if (limit < start + length)\n");
      fprintf(stdout, "          { limit = start + length; }\n");
      fprintf(stdout, "        inbexranges[inbex][0].limit = limit;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    } else {\n");
      fprintf(stdout, "      if (thisbox) {\n"); // if box not empty, new box
//      fprintf(stdout, "        var thisline = thisbox.lastElementChild;\n");
//      fprintf(stdout, "        var thiswisp = thisline.lastElementChild;\n");
//      fprintf(stdout, "        if (thiswisp.className != 'bluewisp') {\n");
//      fprintf(stdout, "          ioaddinbox(inbex);\n");
//      fprintf(stdout, "          thisname = 'in' + inbex;\n");
//      fprintf(stdout, "          thisbox = $$(thisname);\n");
//      fprintf(stdout, "        }\n");
      fprintf(stdout, "        ioclearinbox(thisbox);\n");
//      fprintf(stdout, "      } else {\n"); // if no box, new box
//      fprintf(stdout, "        ioaddinbox(inbex);\n");
//      fprintf(stdout, "        thisname = 'in' + inbex;\n");
//      fprintf(stdout, "        thisbox = $$(thisname);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      inbexranges[inbex][0].start = start;\n");
      fprintf(stdout, "      inbexranges[inbex][0].limit = limit;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    var firstnewlineel = null;\n");
      fprintf(stdout, "    var nli = start - 1;\n");
      fprintf(stdout, "    while (++nli <= start + length - 1) {\n");
      fprintf(stdout, "      var newlinedata = '';\n"); // { 'txt': '', 'rtf': '' };\n");
      fprintf(stdout, "      var newlineindex = nli;\n");
      fprintf(stdout, "      var nextsibling = null;\n"); // cascading..
      fprintf(stdout, "      var newlineel = document.createElement('div');\n");
      fprintf(stdout, "      newlineel.className = 'nor';\n");
      fprintf(stdout, "      newlineel.onmouseover = function(event) {\n");
      fprintf(stdout, "        if (event.currentTarget != event.target) { return; }\n");
// if (event && this != event.target) {\n");
//      fprintf(stdout, "          console.log('chover ' + this.id + ' ' + event.currentTarget.id); return; }\n");
//      fprintf(stdout, "        console.log('mouseover ' + this.isclicking + ' ' + this.id);\n");
      fprintf(stdout, "        this.ishovering = true;\n");
      fprintf(stdout, "        if (thatprevline && thatprevline.isdragging == true)\n");
      fprintf(stdout, "          { this.isdragging = true; linehighlight(this); wispopen('h'); }\n");
      fprintf(stdout, "        thatprevline = this;\n");
      fprintf(stdout, "      };\n");
      fprintf(stdout, "      newlineel.onmouseout = function(event) {\n");
      fprintf(stdout, "        if (!event) { console.log('undefined event'); return; }\n");
      fprintf(stdout, "        if (event.currentTarget != event.target) { return; }\n");
//      fprintf(stdout, "          console.log('chout ' + this.id + ' ' + this.currentTarget); return; }\n");
//      fprintf(stdout, "        console.log('mouseout ' + this.isclicking + ' ' + this.id);\n");
      fprintf(stdout, "        this.ishovering = false;\n");
      fprintf(stdout, "        this.isclicking = false;\n");
      fprintf(stdout, "        wispcountdown = { n: 0, f: null };\n");
      fprintf(stdout, "        if (this.className == 'set') { this.className = 'sel'; }\n");
      fprintf(stdout, "      };\n");
      fprintf(stdout, "      newlineel.onmousedown = function(event) {\n");
      fprintf(stdout, "        console.log('mousedown ' + this.isclicking);\n");
      fprintf(stdout, "        if (event) { event.preventDefault(); } else { return; }\n");
      fprintf(stdout, "        charselect(event.target);\n");
      fprintf(stdout, "        if (this.isclicking == true && wispcountdown.n > 0) {\n");
      fprintf(stdout, "          this.isdragging = true; wispopen('h');\n");
      fprintf(stdout, "        } else {\n");
      fprintf(stdout, "          this.isclicking = true;\n");
      fprintf(stdout, "          var wfunc = function() { if (thatprevline)\n");
      fprintf(stdout, "            { thatprevline.onmouseup(); thatprevline.onmouseout(); } };\n");
      fprintf(stdout, "          wispcountdown = { n: 5, f: wfunc };\n");
      fprintf(stdout, "          linehighlight(this);\n");
      fprintf(stdout, "          if (this.className == 'sel') { this.className = 'set'; }\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      };\n");
      fprintf(stdout, "      newlineel.onmouseup = function(event) {\n");
      fprintf(stdout, "        if (event) { event.preventDefault(); }\n");
      fprintf(stdout, "        this.isdragging = false;\n");
      fprintf(stdout, "      };\n");
      fprintf(stdout, "      var newlinelabel = '=' + newlineindex;\n");
      fprintf(stdout, "      if (nli == start) {\n");
      fprintf(stdout, "        var dtwo = (unlimited == 1) ? ':-' : ':';\n");
      fprintf(stdout, "        newlinelabel += ':' + length + dtwo + limit;\n");
      fprintf(stdout, "        firstnewlineel = newlineel;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      var nlineid = thisname + 'ln' + newlineindex;\n");
      fprintf(stdout, "      newlineel.id = nlineid;\n");
      fprintf(stdout, "      var nlc = '<b class=\"lnum\">' + newlinelabel + '</b>';\n");
      fprintf(stdout, "      nlc += newlinedata;\n");
      fprintf(stdout, "      nlc += '<b id=\"' + nlineid + '=\" class=\"wisp\"></b>';\n");
      fprintf(stdout, "      newlineel.innerHTML = nlc;\n");
//      fprintf(stdout, "      try { \n");
      fprintf(stdout, "      var prescroll = thisbox.scrollHeight;\n");
      fprintf(stdout, "      var preoffset = thisbox.offsetHeight;\n");
      fprintf(stdout, "      var prediffer = prescroll - preoffset;\n");
      fprintf(stdout, "      thisbox.insertBefore(newlineel, nextsibling);\n");
      fprintf(stdout, "      var nwisp = $$(nlineid + '=');\n");
      fprintf(stdout, "      var unbscroll = thisbox.scrollHeight;\n");
      fprintf(stdout, "      var unboffset = thisbox.offsetHeight;\n");
      fprintf(stdout, "      var unbdiffer = unbscroll - unboffset;\n");
// must create the line to test if it goes over the boundary
      fprintf(stdout, "      if (unlimited == 1 && unbdiffer - prediffer > 0) {\n");
      fprintf(stdout, "        newlineel.id = nlineid + '~';\n");
      fprintf(stdout, "        newlineel.className = 'fly';\n");
      fprintf(stdout, "        newlineel.firstChild.innerHTML = '^' + newlineindex;\n");
      fprintf(stdout, "        nwisp.id = nlineid + '=~';\n");
      fprintf(stdout, "        nwisp.className = 'bluewisp';\n");
      fprintf(stdout, "        wispclean.push([6, inbex, newlineindex]);\n");
      fprintf(stdout, "        unlimited = 0;\n");
      fprintf(stdout, "        limit = nli - 1;\n");
      fprintf(stdout, "        length = limit - start + 1;\n");
      fprintf(stdout, "        inbexranges[inbex][0].limit = limit;\n");
      fprintf(stdout, "        var linumel = firstnewlineel.firstChild;\n");
      fprintf(stdout, "        lineval = '=' + start + ':' + length + ':' + limit;\n");
      fprintf(stdout, "        linumel.innerHTML = lineval;\n");
  //    fprintf(stdout, "        lineid[inbosel].removeChild(wispid[inbosel].previousSibling);\n");
                          //      fprintf(stdout, "        ioqueuelist.push(newlineel);\n");
//      fprintf(stdout, "        iohandlequeue();\n");
      fprintf(stdout, "      }\n");
//      fprintf(stdout, "      } catch (e) { var x = 1; }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    ioqueuelist[inbex].push(firstnewlineel);\n");
//      fprintf(stdout, "    highlightnextline(1);\n");
//      fprintf(stdout, "    ioqueuemods();\n");
//      fprintf(stdout, "    wispswitch();\n");
//      fprintf(stdout, "    iohandlequeue();\n");
//      fprintf(stdout, "    if (ioqueuelist.length == 0)\n");
//      fprintf(stdout, "      { ioqueuelist = null; }\n");
//      fprintf(stdout, "    iowrite(newlineindex, '', '-', '00');\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var ioaddlineslimit = 25;\n");
      fprintf(stdout, "  var ioaddlineslength = 5;\n");
      fprintf(stdout, "  function ioaddlines(inbex, start, limit) {\n");
      fprintf(stdout, "    console.log('ioaddlines ' + inbex + ', ' + start + ', ' + limit);\n");
      fprintf(stdout, "    ioaddlinegroup(inbex, 0, start, ioaddlineslength, limit);\n");
      fprintf(stdout, "  }\n");
// set inbox range.. for each page
// ioaddpagefill();
// ioscrollpage(up, down) 
      fprintf(stdout, "  function iosetinboxrange(inbex, start, limit) {\n");
      fprintf(stdout, "    ioaddlines(inbex, start, -limit);\n"); //limit);\n");
      fprintf(stdout, "    iohandlequeue(inbex);\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iosetinboxrangefrominbox(inbex, frominbex) {\n");
      fprintf(stdout, "    var frombox = $$('in' + frominbex);\n");
      fprintf(stdout, "    var fromrange = inbexranges[frominbex][0];\n");
      fprintf(stdout, "    iosetinboxrange(inbex, fromrange.start, fromrange.limit);\n");
      fprintf(stdout, "  }\n");
//      fprintf(stdout, "  var ioscrollinboxstep = 5;\n");
//      fprintf(stdout, "  var ioscrollinboxjump = 20;\n");
      fprintf(stdout, "  function ioscrollinbox(direction) {\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iopageinbox(direction) {\n");
      fprintf(stdout, "    var pgselex = pagesel[inbosel];\n");
      fprintf(stdout, "    var inpglst = inbexranges[inbosel];\n");
      fprintf(stdout, "    var thisbox = $$('in' + inbosel);\n");
      fprintf(stdout, "    if (thisbox) {\n");
      fprintf(stdout, "      if (direction == 'r') {\n");
      fprintf(stdout, "        if (pgselex == 0 || pgselex == inpglst.length) {\n");
      fprintf(stdout, "          var thisline = thisbox.lastElementChild;\n");
      fprintf(stdout, "          var thiswisp = thisline.lastElementChild;\n");
      fprintf(stdout, "          if (thiswisp.className != 'redwisp') {\n");
      fprintf(stdout, "            var oldrange = inbexranges[inbosel][0];\n");
      fprintf(stdout, "            var newstart = oldrange.limit + 1;\n");
      fprintf(stdout, "            var newscope = oldrange.limit - oldrange.start;\n");
      fprintf(stdout, "            var newlimit = newstart + newscope;\n");
      fprintf(stdout, "            iosetinboxrange(inbosel, newstart, newlimit);\n");
      fprintf(stdout, "            iosetinbox(inbosel);\n");
      fprintf(stdout, "            pagesel[inbosel] = inpglst.length;\n");
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        } else if (pgselex < inpglst.length) {\n");
      fprintf(stdout, "          iosetinboxpage(inbosel, pgselex + 1);\n");
      fprintf(stdout, "          pagesel[inbosel] = pgselex + 1;\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "        highlightnextline(0);\n");
 //     fprintf(stdout, "        wispswitch();\n");
      fprintf(stdout, "      } else if (direction == 'l') {\n");
      fprintf(stdout, "        if (pgselex > 1) {\n");
      fprintf(stdout, "          iosetinboxpage(inbosel, pgselex - 1);\n");
      fprintf(stdout, "          pagesel[inbosel] = pgselex - 1;\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "        highlightnextline(0);\n");
 //     fprintf(stdout, "        wispswitch();\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
// ----------------------------------------------------------------------
      fprintf(stdout, "  function wispremoveline(offset) {\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    var deadlineel = lineid[inbosel];\n");
      fprintf(stdout, "    var deadwispel = wispid[inbosel];\n");
      fprintf(stdout, "    var thismode = tabmode[inbosel];\n");
      fprintf(stdout, "    if (!deadlineel || !deadwispel) { return; }\n");
      fprintf(stdout, "    if (wispen == 'n') { return; }\n");
      fprintf(stdout, "    if (thismode != 1) { return; }\n");
      fprintf(stdout, "    if (!ioqueuelist[inbex] || ioqueuelist[inbex].length > 0) { return; }\n");
      fprintf(stdout, "    if (deadwispel.className != 'wisp') { return; }\n");
      fprintf(stdout, "    var inb = ionamebreak(deadlineel.id);\n");
      fprintf(stdout, "    if (inb[0] != 'in') { return; }\n");
      fprintf(stdout, "    var insfx = 0;\n");
      fprintf(stdout, "    if (inb[0] == '.') {\n");
      fprintf(stdout, "      var isb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "      insfx = isb[1];\n");
      fprintf(stdout, "      inb[2] = isb[2];\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    var insuffix = (insfx == 0) ? '' : '.' + insfx;\n");
      fprintf(stdout, "    var lnb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "    if (lnb[0] != 'ln') { return; }\n");
      fprintf(stdout, "    var deadlineindex = lnb[1];\n");
      fprintf(stdout, "    var deadlinelnum = deadlineel.firstElementChild;\n");
      fprintf(stdout, "    var deadlinelock = deadlinelnum.nextElementSibling;\n");
      fprintf(stdout, "    var dlwispcl = (deadlinelock) ? deadlinelock.className : '';\n");
      fprintf(stdout, "    if (dlwispcl && dlwispcl.substr(-4) == 'wisp')\n");
      fprintf(stdout, "      { deadlinelock = deadlinelock.nextElementSibling; }\n");
      fprintf(stdout, "    if (deadlinelock && deadlinelock.innerText == ']')\n");
      fprintf(stdout, "      { console.log('locked...'); return; }\n");
//      fprintf(stdout, "    else { console.log(deadlinelock.innerText); }\n");
      fprintf(stdout, "    var toprevline = true;\n");
      fprintf(stdout, "    if (offset == -2)\n");
      fprintf(stdout, "      { toprevline = false; offset = -1; }\n");
//      fprintf(stdout, "    if (deadlineindex <= 1) {\n");
//      fprintf(stdout, "      if (deadlineindex == 1) {\n");
//      fprintf(stdout, "        if (deadwispel.nextElementSibling)\n");
//      fprintf(stdout, "          { return; }\n");
//      fprintf(stdout, "        else { toprevline = false; }\n");
//      fprintf(stdout, "      } else { return; }\n");
//      fprintf(stdout, "    }\n");
//      fprintf(stdout, "    if (deadlineindex <= 1)\n");
//      fprintf(stdout, "      { highlightnextline(1); }\n");
//      fprintf(stdou t, "    else { highlightprevline(1); }\n");
      fprintf(stdout, "    if (offset == -1) {\n");
//      fprintf(stdout, "      wispgoto('peol');\n");
      fprintf(stdout, "      highlightprevline(1);\n");
      fprintf(stdout, "      wispgoto('teol');\n");
      fprintf(stdout, "      var deadlinewisp = $$(deadlineel.id + '=');\n");
      fprintf(stdout, "      if (toprevline && deadlinewisp.parentElement == deadlineel) {\n");
      fprintf(stdout, "        var tolineel = lineid[inbosel];\n");
      fprintf(stdout, "        var towispel = wispid[inbosel];\n");
      fprintf(stdout, "        if (towispel.parentElement != tolineel) {\n");
      fprintf(stdout, "          var tosublineel = towispel.parentElement;\n");
      fprintf(stdout, "          while (deadlinewisp.nextElementSibling) {\n");
      fprintf(stdout, "            var deadlinechar = deadlinewisp.nextElementSibling;\n");
      fprintf(stdout, "            var deadlineclass = deadlinechar.className;\n");
      fprintf(stdout, "            if (deadlineclass == 'line' || deadlineclass == 'subline') {\n");
      fprintf(stdout, "              if (deadlineclass == 'subline') { wispkey('~'); }\n");
      fprintf(stdout, "              while (deadlinechar.firstElementChild)\n");
      fprintf(stdout, "                { tosublineel.insertBefore(deadlinechar.firstElementChild, towispel); }\n");
      fprintf(stdout, "            }\n");
      fprintf(stdout, "            var deadlinenext = deadlinewisp.nextElementSibling;\n");
      fprintf(stdout, "            deadlineel.insertBefore(deadlinewisp, deadlinenext.nextElementSibling);\n");
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        }\n"); // copy chars after wisp to prev line
//      fprintf(stdout, "        ioqueuelist[inbex].push(tolineel);\n");
      fprintf(stdout, "        iosetmod(inbex, tolineel, 1);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    } else { highlightnextline(1); }\n");
//      fprintf(stdout, "    iosetmod(inbex, deadlineel, 1);\n"); // add to queue, remove this
//      fprintf(stdout, "    wispswitch();\n");
      fprintf(stdout, "    var deadlineid = 'in' + inb[1] + 'ln' + deadlineindex;\n");
      fprintf(stdout, "    deadlineel.id = deadlineid + '~';\n");
      fprintf(stdout, "    deadlineel.className = 'die';\n");
      fprintf(stdout, "    deadlineel.firstChild.innerHTML = '-' + deadlineindex;\n");
      fprintf(stdout, "    deadwispel.id = deadlineid + '=~';\n");
      fprintf(stdout, "    deadwispel.className = 'redwisp';\n");
      fprintf(stdout, "    var dli = deadlineindex;\n");
      fprintf(stdout, "    while (++dli > 0) {\n"); //<= inboxdata.numlines) {\n");
      fprintf(stdout, "      var dlni = dli - 1;\n");
//      fprintf(stdout, "      var thislinedata = inboxdata.lines['l' + dli];\n");
//      fprintf(stdout, "      inboxdata.lines['l' + dlni] = thislinedata;\n");
      fprintf(stdout, "      var thislineid = 'in' + inb[1] + 'ln' + dli;\n");
      fprintf(stdout, "      var thislineel = $$(thislineid);\n");
      fprintf(stdout, "      if (thislineel) {\n");
      fprintf(stdout, "        thislineel.id = 'in' + inb[1] + 'ln' + dlni;\n");
      fprintf(stdout, "        thislineel.firstChild.innerHTML = '' + dlni;\n");
      fprintf(stdout, "        var thiswispel = $$(thislineid + '=');\n");
      fprintf(stdout, "        if (thiswispel)\n");
      fprintf(stdout, "          { thiswispel.id = 'in' + inb[1] + 'ln' + dlni + '='; }\n");
      fprintf(stdout, "      } else { break; }\n");
      fprintf(stdout, "    }\n"); // shift later lines -1
//      fprintf(stdout, "    iohandlequeue(inbex);\n");
      fprintf(stdout, "    iosetmod(inbex, deadlineel, 1);\n");
      fprintf(stdout, "    ioqueuemods(inbex);\n"); // write other pending
//      fprintf(stdout, "    ioqueuelist[inbex].push(deadlineel);\n");
//      fprintf(stdout, "    inboxdata.numlines--;\n");
      fprintf(stdout, "    iohandlequeue(inbex);\n");
//      fprintf(stdout, "    if (ioqueuelist.length == 0)\n");
//      fprintf(stdout, "      { ioqueuelist = null; }\n");
//      fprintf(stdout, "    iowrite(deadlineindex, '', '00', '-');\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function wispbackspace(count, shift) {\n");
      fprintf(stdout, "    var inbex = inbosel;\n");
      fprintf(stdout, "    var thisline = lineid[inbosel];\n");
      fprintf(stdout, "    var thiswisp = wispid[inbosel];\n");
      fprintf(stdout, "    var wispline = thiswisp.parentElement;\n");
      fprintf(stdout, "    var thismode = tabmode[inbosel];\n");
      fprintf(stdout, "    var thislindex = linesel[inbosel];\n");
      fprintf(stdout, "    if (zerosel[inbosel] == 1) { thislindex = 0; }\n");
      fprintf(stdout, "    if (!thisline || !thiswisp) { return; }\n");
      fprintf(stdout, "    if (wispen == 'n') { return; }\n");
      fprintf(stdout, "    if (thismode != 1) { return; }\n");
      fprintf(stdout, "    if (thiswisp.className == 'redwisp') { return; }\n");
      fprintf(stdout, "    var thiswisppr = thiswisp.previousElementSibling;\n");
      fprintf(stdout, "    if (thiswisp.className == 'bluewisp' && (!thiswisppr\n");
      fprintf(stdout, "        || thiswisppr.className == 'lnum')) { return; }\n");
      fprintf(stdout, "    var thiswispnx = thiswisp.nextElementSibling;\n");
      fprintf(stdout, "    var thiswispnxc = (thiswispnx) ? thiswispnx.className : '';\n");
      fprintf(stdout, "    var thislinepr = thisline.previousElementSibling;\n");
      fprintf(stdout, "    var thislinefe = thisline.firstElementChild;\n");
      fprintf(stdout, "    var thislinefl = thisline.parentElement.firstElementChild;\n");
      fprintf(stdout, "    var thislinefenx = thislinefe.nextElementSibling;\n");
      fprintf(stdout, "    var thislinefenxc = (thislinefenx) ? thislinefenx.className : '';\n");
      fprintf(stdout, "    var thisfirstline = (thisline == thislinefl);\n");
//      fprintf(stdout, "    if (thiswisppr.className == 'rsqb' && count > 0) {\n");
//      fprintf(stdout, "      wispbackspace(0, 0);\n");
//      fprintf(stdout, "    } else if (!thiswispnx && thislinefenxc == 'rsqb') {\n");
//      fprintf(stdout, "      wispgoto('tsol'); wispgoto('trht');\n");
//      fprintf(stdout, "      wispbackspace(0, 0); wispgoto('teol');\n");
//      fprintf(stdout, "    } else if (thiswisppr == thislinefe && thislindex) {\n");
//      fprintf(stdout, "      if (thiswispnxc != 'rsqb' && shift)\n");
//      fprintf(stdout, "        { wispremoveline(-1); }\n"); // iohandlequeue(inbex); }\n");
      fprintf(stdout, "    if (!thiswisppr && thislindex > 1) {\n"); // note! what if start of subline?
//      fprintf(stdout, "      if (thiswispnxc != 'rsqb' && shift)\n");
      fprintf(stdout, "       wispgoto('tlft', false); wispremoveline(-1);\n");
      fprintf(stdout, "    } else if (thislinefenxc != 'rsqb' || count == 0) {\n");
//      fprintf(stdout, "      if (wispen == 'n') { return; }\n"); // ..? repeated,uncond,remove
      fprintf(stdout, "      if (count == 0) { count = 1; }\n");
      fprintf(stdout, "      var modded = 'n';\n");
      fprintf(stdout, "      while (--count >= 0) {\n");
      fprintf(stdout, "        var delchar = thiswisp.previousSibling;\n");
      fprintf(stdout, "        if (!delchar) { break; }\n");
      fprintf(stdout, "        if (delchar.className == 'lnum') { break; }\n");
      fprintf(stdout, "        wispline.removeChild(delchar);\n");
      fprintf(stdout, "        modded = 'y';\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      if (modded == 'y')\n");
      fprintf(stdout, "        { iosetmod(inbex, thisline, 1); }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      // -----------------------------------------------------------------------------------
//      fprintf(stdout, "  var iourl = 'http://%s%s';\n", TABTIBHOST, TABTIBURL);
      fprintf(stdout, "  var iourl = '%s';\n", TABTIBURL);
      fprintf(stdout, "  var iofile = { url: '', val: '', set: '{}', node: '' };\n");
      fprintf(stdout, "  var iofiles = [[], [], [], [], [], [], [], [], [], [], []];\n");
      fprintf(stdout, "  function iosetget(name) {\n");
      fprintf(stdout, "    var ifs = iofile.set;\n");
      fprintf(stdout, "    var sni = ifs.indexOf('{' + name + ':');\n");
      fprintf(stdout, "    var snj = ifs.indexOf(',' + name + ':');\n");
      fprintf(stdout, "    var snk = (sni != -1) ? sni : (snj != -1) ? snj : -1;\n");
      fprintf(stdout, "    var snl = (snk != -1) ? ifs.substr(snk + 1 + name.length) : '';\n");
      fprintf(stdout, "    var snm = snl.indexOf(',');\n");
      fprintf(stdout, "    var snn = snl.indexOf('}');\n");
      fprintf(stdout, "    var sno = (snm != -1) ? snm : (snn != -1) ? snn : -1;\n");
      fprintf(stdout, "    var snp = (sno != -1) ? snl.substr(0, sno) : '';\n");
//      fprintf(stdout, "    console.log(name + snp);\n");
      fprintf(stdout, "    return (snp.charAt(0) == ':') ? snp.substr(1) : '';\n");
      fprintf(stdout, "  }\n");
/*
      fprintf(stdout, "  function iosync() {\n");
      fprintf(stdout, "    var uri = document.location.href;\n");
      fprintf(stdout, "    var urq = uri.indexOf('?');\n");
      fprintf(stdout, "    var ura = (urq == -1) ? '{}' : uri.substr(urq + 1);\n");
      fprintf(stdout, "    var urp = ura.indexOf('{');\n");
      fprintf(stdout, "    var urv = (urp == -1) ? ura : ura.substr(0, urp);\n");
      fprintf(stdout, "    var urs = (urp == -1) ? '{}' : ura.substr(urp);\n");
      fprintf(stdout, "    iofile = { url: uri, val: urv, set: urs, node: '' };\n");
      fprintf(stdout, "  }\n");
*/
      fprintf(stdout, "  function iosync() {\n");
      fprintf(stdout, "    var uri = document.location.href;\n");
      fprintf(stdout, "    var urv = \"%s\";\n", filename);
      fprintf(stdout, "    iofile = { url: uri, val: urv, set: '{}', node: '' };\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function ioparam(iotxt, name) {\n");
      fprintf(stdout, "    var fnm = '\"' + name + '\": \"';\n");
      fprintf(stdout, "    var fni = iotxt.indexOf(fnm);\n");
      fprintf(stdout, "    if (fni == -1) { return ''; }\n");
      fprintf(stdout, "    var fns = iotxt.substr(fni + fnm.length);\n");
      fprintf(stdout, "    var fnj = fns.indexOf('\"');\n");
      fprintf(stdout, "    if (fnj == -1) { return ''; }\n");
      fprintf(stdout, "    var fnv = fns.substr(0, fnj);\n");
      fprintf(stdout, "    return fnv;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function ioparamreplace(iotxt, name, value) {\n");
      fprintf(stdout, "    var fnm = '\"' + name + '\": \"';\n");
      fprintf(stdout, "    var fni = iotxt.indexOf(fnm);\n");
      fprintf(stdout, "    if (fni == -1) { return iotxt; }\n");
      fprintf(stdout, "    var fnbs = iotxt.substr(0, fni + fnm.length);\n");
      fprintf(stdout, "    var fns = iotxt.substr(fni + fnm.length);\n");
      fprintf(stdout, "    var fnj = fns.indexOf('\"');\n");
      fprintf(stdout, "    if (fnj == -1) { return iotxt; }\n");
      fprintf(stdout, "    var fnv = fns.substr(0, fnj);\n");
      fprintf(stdout, "    var fnav = fns.substr(fnj);\n");
      fprintf(stdout, "    return fnbs + value + fnav;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var iologmessages = [];\n");
      fprintf(stdout, "  function iologmessage(message) {\n");
      fprintf(stdout, "    iologmessages.push(message);\n");
      fprintf(stdout, "    if (iologmessages.length > 16)\n");
      fprintf(stdout, "      { iologmessages.shift(); }\n");
      fprintf(stdout, "    var logtxt = '' + iologmessages[0];\n");
      fprintf(stdout, "    var lmi = 0;\n");
      fprintf(stdout, "    while (++lmi < iologmessages.length) {\n");
      fprintf(stdout, "      if (iologmessages[lmi].charAt(0) == '[') {\n");
      fprintf(stdout, "        logtxt += '<br>' + iologmessages[lmi];\n");
      fprintf(stdout, "      } else {\n");
      fprintf(stdout, "        if (logtxt.substr(-1) == ']')\n");
      fprintf(stdout, "          { logtxt += '<br>'; }\n");
      fprintf(stdout, "        logtxt += iologmessages[lmi];\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    $$('logtext').innerHTML = logtxt;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function commboxesdisplay(value) {\n");
      fprintf(stdout, "    var commboxes = 4;\n");
      fprintf(stdout, "    while (--commboxes >= 0) {\n");
      fprintf(stdout, "      var tcb = $$('commbox' + commboxes);\n");
      fprintf(stdout, "      tcb.style.display = value;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function commboxesshiftup(newcontent) {\n");
      fprintf(stdout, "    var commboxes = 4;\n");
      fprintf(stdout, "    while (--commboxes > 0) {\n");
      fprintf(stdout, "      var tcb = $$('commbox' + commboxes);\n");
      fprintf(stdout, "      var pcb = $$('commbox' + (commboxes - 1));\n");
      fprintf(stdout, "      tcb.innerHTML = pcb.innerHTML;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    $$('commbox0').innerHTML = newcontent;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function ioload(response) {\n");
      fprintf(stdout, "    var inbex = inbosel;\n"); // = n;
// mutual exclusion? ioopening/iosaving ... maybe n frames and ioload(n)
//      fprintf(stdout, "    var icw = $$('ioframe').contentWindow;\n");
//      fprintf(stdout, "    if (!icw) { return false; }\n");
      fprintf(stdout, "    var ioc = response;\n"); // icw.document.body.innerHTML;\n");
      fprintf(stdout, "    var iod = ioc;\n");
      fprintf(stdout, "    var filenode = ioparam(ioc, 'node');\n");
      fprintf(stdout, "    var fileseek = ioparam(ioc, 'seek');\n");
      fprintf(stdout, "    var fileresult = ioparam(ioc, 'result');\n");
      fprintf(stdout, "    var fileseekchar = fileseek.charAt(0);\n");
      fprintf(stdout, "    if (fileseekchar == 'o') {\n");
      fprintf(stdout, "      var endresult = '[ <b>file not opened</b> ]';\n");
      fprintf(stdout, "      if (fileresult == 'success') {\n");
//      fprintf(stdout, "        var canlistcmd = 'y';\n");
//      fprintf(stdout, "        if (iofile.node == '' || canlistcmd == 'y') {\n");
//      fprintf(stdout, "          iofile.node = filenode;\n");
//      fprintf(stdout, "        iofiles[0].push({ in: 0, node: filenode, from: null });\n");
      fprintf(stdout, "        var iop = ioopening;\n");
      fprintf(stdout, "        var iof = iofiles[iop][iofiles[iop].length - 1];\n");
      fprintf(stdout, "        iof.node = filenode;\n");
      fprintf(stdout, "        if (iof.from.in == 0 && iof.from.node == '')\n");
      fprintf(stdout, "          { iof.from.node = filenode; }\n");
      fprintf(stdout, "        if (ioqueuelist[iop]) {\n");
      fprintf(stdout, "          iohandlequeue(iop);\n");
      fprintf(stdout, "        } else { ioqueuelist[iop] = []; }\n");
      fprintf(stdout, "        endresult = '<u class=\"o\">#</u>';\n");
//      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      iologmessage(endresult);\n");
      fprintf(stdout, "    } else if (fileseekchar == 'c') {\n");
      fprintf(stdout, "      var endresult = '[ <b>command not opened</b> ]';\n");
      fprintf(stdout, "      if (fileresult == 'success') {\n");
      fprintf(stdout, "        var canlistcmd = 'y';\n");
      fprintf(stdout, "        if (canlistcmd == 'y') {\n");
//      fprintf(stdout, "          var cmdsrc = iofiles[inbosel][iofiles[inbosel].length - 1];\n");
      fprintf(stdout, "          iofiles[10][iofiles[10].length - 1].node = node;\n");
      fprintf(stdout, "          if (ioqueuelist[10]) {\n");
      fprintf(stdout, "            iohandlequeue(10);\n");
      fprintf(stdout, "          } else { ioqueuelist[10] = []; }\n");
      fprintf(stdout, "          endresult = '<u class=\"c\">#</u>';\n");
      fprintf(stdout, "        } else { console.log('nocmd'); }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      iologmessage(endresult);\n");
      fprintf(stdout, "    } else if (fileseekchar == 'l') {\n");
      fprintf(stdout, "      var endresult = '[ <b>line not read</b> ]';\n");
      fprintf(stdout, "      if (fileresult == 'success') {\n");
      fprintf(stdout, "        var lineeof = ioparam(ioc, 'elof');\n");
      fprintf(stdout, "        lineeof = parseInt(lineeof);\n");
      fprintf(stdout, "        var linenum = fileseek.substr(2, fileseek.indexOf(' ') - 2);\n");
      fprintf(stdout, "        var linestart = ionamebreak(linenum);\n");
      fprintf(stdout, "        var linelen = ionamebreak(linestart[2]);\n");
      fprintf(stdout, "        var linelim = ionamebreak(linelen[2]);\n");
      fprintf(stdout, "        var linbex = ionamebreak(linelim[2]);\n");
      fprintf(stdout, "        var linpage = ionamebreak(linbex[2]);\n");
      fprintf(stdout, "        var linsuffix = (linpage[1] == 0) ? '' : '.' + linpage[1];\n");
      fprintf(stdout, "        var linname = 'in' + linbex[1] + linsuffix;\n");
      fprintf(stdout, "        var morelines = 0;\n");
      fprintf(stdout, "        if (linelen[0].charAt(0) == ':') {\n");
      fprintf(stdout, "          if (linelim[0].charAt(0) == ':') {\n");
      fprintf(stdout, "            var linenextstart = linestart[1] + linelen[1];\n");
      fprintf(stdout, "            if (linelim[1] > lineeof)\n");
      fprintf(stdout, "              { linelim[1] = lineeof; }\n");
      fprintf(stdout, "            if (linenextstart <= linelim[1]) {\n");
      fprintf(stdout, "              morelines = 1;\n");
      fprintf(stdout, "              var lstt = linenextstart;\n");
      fprintf(stdout, "              var llen = 0 - linelen[1];\n");
      fprintf(stdout, "              var llim = linelim[1];\n");
      fprintf(stdout, "              if (linelim[0].substr(-1) == '-')\n");
      fprintf(stdout, "                { llim = 0 - linelim[1]; }\n");
      fprintf(stdout, "              ioaddlinegroup(linbex[1], linpage[1], lstt, llen, llim);\n");
      fprintf(stdout, "              iohandlequeue(linbex[1]);\n");
      fprintf(stdout, "            }\n");
      fprintf(stdout, "          } else {\n");
      fprintf(stdout, "            linelim = ['', linelen[1]];\n");
      fprintf(stdout, "            linelen = ['', 1];\n");
      fprintf(stdout, "            if (linelim[1] > lineeof)\n");
      fprintf(stdout, "              { linelim[1] = lineeof; }\n");
      fprintf(stdout, "            if (0 - linelim[1] > lineeof)\n");
      fprintf(stdout, "              { linelim[1] = lineeof; }\n");
      fprintf(stdout, "            if (linestart[1] < linelim[1]) {\n");
      fprintf(stdout, "              morelines = 1;\n");
      fprintf(stdout, "              ioaddlinegroup(linbex[1], linpage[1], linestart[1] + 1, 0 - linelen[1], linelim[1]);\n");
      fprintf(stdout, "              iohandlequeue(linbex[1]);\n");
      fprintf(stdout, "            }\n");
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        } else {\n");
      fprintf(stdout, "          linelim = ['', linestart[1]];\n");
      fprintf(stdout, "          linelen = ['', 0];\n");
      fprintf(stdout, "          if (linelim[1] > lineeof)\n");
      fprintf(stdout, "            { linelim[1] = lineeof; }\n");
      fprintf(stdout, "          if (0 - linelim[1] > lineeof)\n");
      fprintf(stdout, "            { linelim[1] = lineeof; }\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "        var thl = linestart[1] - 1;\n");
      fprintf(stdout, "        var thlim = linestart[1] + linelen[1] - 1;\n");
      fprintf(stdout, "        while (++thl <= thlim) {\n");
      fprintf(stdout, "          if (thl > lineeof) {\n");
 //     fprintf(stdout, "            var ini = -1;\n");
 //     fprintf(stdout, "            while (++ini < inbexpos.length) {\n");
      fprintf(stdout, "            var lbn = linname + 'ln' + thl;\n");
      fprintf(stdout, "            if ($$(lbn)) {\n");
      fprintf(stdout, "              var lbl = $$(lbn).firstChild.innerHTML;\n");
      fprintf(stdout, "              var lbs = ionamebreak(lbl);\n");
      fprintf(stdout, "              if (lbs[0] == '=') {\n");
      fprintf(stdout, "                $$(lbn).removeChild($$(lbn + '='));\n");
      fprintf(stdout, "                $$(lbn).parentNode.removeChild($$(lbn));\n");
      fprintf(stdout, "              }\n");
      fprintf(stdout, "            }\n");
//      fprintf(stdout, "            }\n");
      fprintf(stdout, "          } else {\n");
      fprintf(stdout, "            var basebuf = ioparam(ioc, 'line' + thl);\n");
      fprintf(stdout, "            var linebuf = basecodestring(basebuf);\n");
      fprintf(stdout, "            var linetxt = '(' + linebuf.length + ' bytes)';\n");
      fprintf(stdout, "            iod = ioparamreplace(iod, 'line' + thl, linetxt);\n");
//      fprintf(stdout, "            var ini = -1;\n");
//      fprintf(stdout, "            while (++ini < inbexpos.length) {\n");
      fprintf(stdout, "            var lbn = linname + 'ln' + thl;\n");
      fprintf(stdout, "            if ($$(lbn)) {\n");
      fprintf(stdout, "              var linehead = '<b class=\"lnum\">' + thl + '</b>';\n");
      fprintf(stdout, "              var linewisp = '<b id=\"' + lbn + '=\"';\n");
      fprintf(stdout, "              if (thl >= lineeof)\n");
      fprintf(stdout, "                { linewisp += ' class=\"redwisp\"></b>'; }\n");
      fprintf(stdout, "              else { linewisp += ' class=\"wisp\"></b>'; }\n");
//      fprintf(stdout, "              $$(lbn).innerHTML = linehead + linebuf + linewisp;\n");
      fprintf(stdout, "              $$(lbn).innerHTML = linehead + linewisp + linebuf;\n");
      fprintf(stdout, "              highlightifpending(linbex[1], thl);\n");
      fprintf(stdout, "              var lcn = $$(lbn).className;\n");
      fprintf(stdout, "              if (lcn == 'sel' || lcn == 'set' || lcn == 'sox' ||\n");
      fprintf(stdout, "                  lcn == 'sol' || lcn == 'sal')\n");
      fprintf(stdout, "                { $$(lbn).className = 'six'; }\n");
      fprintf(stdout, "              else { $$(lbn).className = 'fix'; }\n");
      fprintf(stdout, "            }\n");
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "        rehighlightline(inbosel);\n");
      fprintf(stdout, "        wispswitch();\n");
      fprintf(stdout, "        endresult = '<u class=\"l\">' + linestart[1] + '</u>';\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      iologmessage(endresult);\n");
      fprintf(stdout, "    } else if (fileseekchar == 'a' || fileseekchar == 'r') {\n");
      fprintf(stdout, "      var endaction = (fileseekchar == 'a') ? 'added' : 'replaced';\n");
      fprintf(stdout, "      var endresult = '[ <b>line not ' + endaction + '</b> ]';\n");
      fprintf(stdout, "      if (fileresult == 'success') {\n");
      fprintf(stdout, "        var linenum = fileseek.substr(2, fileseek.indexOf(' ') - 2);\n");
      fprintf(stdout, "        var linestart = ionamebreak(linenum);\n");
      fprintf(stdout, "        var linelen = ionamebreak(linestart[2]);\n");
      fprintf(stdout, "        var linelim = ionamebreak(linelen[2]);\n");
      fprintf(stdout, "        var linbex = ionamebreak(linelim[2]);\n");
      fprintf(stdout, "        var linpage = ionamebreak(linbex[2]);\n");
      fprintf(stdout, "        var linsuffix = (linpage[1] == 0) ? '' : '.' + linpage[1];\n");
      fprintf(stdout, "        var linname = 'in' + linbex[1] + linsuffix;\n");
      fprintf(stdout, "        var basebuf = ioparam(ioc, 'line');\n");
      fprintf(stdout, "        var linebuf = basecodestring(basebuf);\n");
      fprintf(stdout, "        var linetxt = '(' + linebuf.length + ' bytes)';\n");
      fprintf(stdout, "        iod = ioparamreplace(ioc, 'line', linetxt);\n");
      fprintf(stdout, "        var lbn = linname + 'ln' + linestart[1];\n");
      fprintf(stdout, "        if ($$(lbn)) {\n");
      fprintf(stdout, "          var linehead = '<b class=\"lnum\">' + linestart[1] + '</b>';\n");
      fprintf(stdout, "          var linewisp = '<b id=\"' + lbn + '=\" class=\"wisp\"></b>';\n");
//      fprintf(stdout, "          $$(lbn).innerHTML = linehead + linebuf + linewisp;\n");
      fprintf(stdout, "          $$(lbn).innerHTML = linehead + linewisp + linebuf;\n");
      fprintf(stdout, "          var linebox = $$(lbn + '=').nextElementSibling;\n");
      fprintf(stdout, "          linebox.insertBefore($$(lbn + '='), linebox.firstElementChild);\n");
      fprintf(stdout, "          if (fileseekchar == 'a') {\n");
      fprintf(stdout, "            var dlr = inbexranges[linbex[1]][linpage[1]];\n");
      fprintf(stdout, "            var dln = linname + 'ln' + dlr.limit;\n");
      fprintf(stdout, "            var dline = $$(dln + '~');\n");
      fprintf(stdout, "            var dwisp = $$(dln + '=~');\n");
      fprintf(stdout, "            if (dline && dwisp) {\n");
//      fprintf(stdout, "              dline.removeChild(dwisp);\n"); // cannot assume wisp is an immediate child
      fprintf(stdout, "              dline.parentElement.removeChild(dline);\n");
      fprintf(stdout, "            }\n"); // delete bottom line
      fprintf(stdout, "            highlightifpending(linbex[1], linestart[1]);\n");
      fprintf(stdout, "          }\n"); // if adding line
      fprintf(stdout, "          var lcn = $$(lbn).className;\n");
      fprintf(stdout, "          if (lcn == 'sel' || lcn == 'set' || lcn == 'sox' ||\n");
      fprintf(stdout, "              lcn == 'sol' || lcn == 'sal')\n");
      fprintf(stdout, "            { $$(lbn).className = 'six'; }\n");
      fprintf(stdout, "          else { $$(lbn).className = 'fix'; }\n");
      fprintf(stdout, "          wispswitch();\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "        var endclass = (fileseekchar == 'a') ? 'a' : 'r';\n");
      fprintf(stdout, "        endresult = '<u class=\"' + endclass + '\">' + linestart[1] + '</u>';\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      iologmessage(endresult);\n");
      fprintf(stdout, "    } else if (fileseekchar == 'd') {\n");
      fprintf(stdout, "      var endresult = '[ <b>line not deleted</b> ]';\n");
      fprintf(stdout, "      if (fileresult == 'success') {\n");
      fprintf(stdout, "        var linenum = fileseek.substr(2, fileseek.indexOf(' ') - 2);\n");
      fprintf(stdout, "        var linestart = ionamebreak(linenum);\n");
      fprintf(stdout, "        var linelen = ionamebreak(linestart[2]);\n");
      fprintf(stdout, "        var linelim = ionamebreak(linelen[2]);\n");
      fprintf(stdout, "        var linbex = ionamebreak(linelim[2]);\n");
      fprintf(stdout, "        var linpage = ionamebreak(linbex[2]);\n");
      fprintf(stdout, "        var linsuffix = (linpage[1] == 0) ? '' : '.' + linpage[1];\n");
      fprintf(stdout, "        var linname = 'in' + linbex[1] + linsuffix;\n");
      fprintf(stdout, "        var dln = linname + 'ln' + linestart[1];\n");
      fprintf(stdout, "        var dline = $$(dln + '~');\n");
      fprintf(stdout, "        var dwisp = $$(dln + '=~');\n");
      fprintf(stdout, "        if (dline && dwisp) {\n");
      fprintf(stdout, "          dwisp.parentElement.removeChild(dwisp);\n");
      fprintf(stdout, "          dline.parentElement.removeChild(dline);\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "        endresult = '<u class=\"d\">' + linestart[1] + '</u>';\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      iologmessage(endresult);\n");
      fprintf(stdout, "    } else if (fileseekchar == 's') {\n");
      fprintf(stdout, "      var endresult = '[ <b>file not saved</b> ]';\n");
      fprintf(stdout, "      if (fileresult == 'success') {\n");
      fprintf(stdout, "        var ios = iosaving;\n");
      fprintf(stdout, "        if (!ioqueuelist[ios]) {\n");
      fprintf(stdout, "          ioqueuelist[ios] = [];\n");
      fprintf(stdout, "          endresult = '<u class=\"s\">@' + ios + '</u>';\n");
      fprintf(stdout, "        } else {\n");
      fprintf(stdout, "          endresult = '<u class=\"s\">!!' + ios + '</u>';\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      iologmessage(endresult);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    commboxesshiftup(iod);\n");
      fprintf(stdout, "    iohandlequeue(inbosel);\n"); // ioopening or iosaving, inbex via n
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var iopending = [];\n");
      fprintf(stdout, "  var iosending = false;\n");
      fprintf(stdout, "  function iopend(val, svl, fvl, lvl, cvl, ovl, nvl) {\n");
      fprintf(stdout, "    var vpar = '{s:' + svl + ',f:' + fvl + ',l:' + lvl;\n");
      fprintf(stdout, "    vpar += ',c:' + cvl + ',o:' + ovl + ',n:' + nvl + '}';\n");
      fprintf(stdout, "    var vurl = iourl + '?' + val + vpar;\n");
      fprintf(stdout, "    iopending.push(vurl);\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iosend() {\n");
      fprintf(stdout, "    if (iosending) { return false; }\n");
      fprintf(stdout, "    if (!iopending.length) { return false; }\n");
      fprintf(stdout, "    iosending = true;\n");
      fprintf(stdout, "    var vurl = iopending.shift();\n");
      fprintf(stdout, "    var xhr = new XMLHttpRequest();\n");
      fprintf(stdout, "    xhr.onreadystatechange = function(event) {\n");
//      fprintf(stdout, "      console.log(xhr.readyState);\n");
      fprintf(stdout, "      if (xhr.readyState == 4) {\n");
//      fprintf(stdout, "        console.log(xhr.responseText);\n");
      fprintf(stdout, "        var loaddata = xhr.responseText;\n");
      fprintf(stdout, "        loaddata = loaddata.substr(loaddata.indexOf('<body>') + 6);\n");
      fprintf(stdout, "        loaddata = loaddata.substr(0, loaddata.indexOf('</body>'));\n");
      fprintf(stdout, "        if (xhr.status == 200) {\n");
      fprintf(stdout, "          ioload(loaddata);\n");
      fprintf(stdout, "          iosending = false;\n");
      fprintf(stdout, "        } else {\n");
      fprintf(stdout, "          console.log('NETWORK ERROR');\n");
      fprintf(stdout, "          console.log(loaddata);\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    };\n");
      fprintf(stdout, "    xhr.open('GET', vurl, true);\n");
      fprintf(stdout, "    xhr.send();\n");
//      fprintf(stdout, "    try {\n");
//      fprintf(stdout, "      $$(\'ioframe\').src = vurl;\n");
//      fprintf(stdout, "    } catch (e) {\n");
//      fprintf(stdout, "      iologmessage('[<u>NETWORK ERROR</u>]');\n");
//      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var ioopening = -1;\n");
      fprintf(stdout, "  var iosaving = -1;\n");
      fprintf(stdout, "  var iocmding = -1;\n");
      fprintf(stdout, "  function ioopen(inbex, cmd, tobex) {\n");
      fprintf(stdout, "    var cmdpre = cmd.substr(0, 1);\n");
      fprintf(stdout, "    if (inbex == 0 && cmdpre == '~') {\n");
      fprintf(stdout, "      iosync();\n");
      fprintf(stdout, "      iofiles[0].push({ in: 0, node: '', from: iofile.val });\n");
//      fprintf(stdout, "      var ifs = iosetget('s');\n");
//      fprintf(stdout, "      var ifv = stringbasecode(iofile.val);\n");
//      fprintf(stdout, "      iosend(ifv, ifs, '-', '-', '-', '-');\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (cmdpre == '~') {\n");
      fprintf(stdout, "      var openfrom = iofiles[inbex][iofiles[inbex].length - 1];\n");
      fprintf(stdout, "      iofiles[tobex].push({ in: tobex, node: '', from: openfrom });\n");
      fprintf(stdout, "      var ifs = iosetget('s'); ifs = 0;\n");
      fprintf(stdout, "      var ifn = cmd.substr(1);\n");
      fprintf(stdout, "      if (ifn.substr(0, 1) != '/')\n");
      fprintf(stdout, "        { ifn = iofile.val + ifn; }\n");
      fprintf(stdout, "      var ifv = stringbasecode(ifn);\n");
      fprintf(stdout, "      ioopening = tobex;\n");
      fprintf(stdout, "      ioclearinbox(tobex);\n");
      fprintf(stdout, "      iosetinbox(tobex);\n");
      fprintf(stdout, "      iopend(ifv, ifs, '-', '-', '-', '-', '-');\n");
//      fprintf(stdout, "      ioaddlines(tobex, 1, -25);\n"); // CHECK THIS ....
      fprintf(stdout, "    } else if (cmdpre == '@') {\n");
      fprintf(stdout, "      var cmdfrom = iofiles[inbex][iofiles[inbex].length - 1];\n");
      fprintf(stdout, "      iofiles[10].push({ in: 10, node: '', from: cmdfrom });\n");
      fprintf(stdout, "      iocmding = 10;\n"); // tobex later
      fprintf(stdout, "      var ifs = iosetget('s'); ifs = 0;\n");
      fprintf(stdout, "      var ifv = stringbasecode(cmd);\n");
      fprintf(stdout, "      iopend(ifv, ifs, '-', '-', '-', '-', '-');\n");
//      fprintf(stdout, "      ioaddinbox(inbosel);\n");
      fprintf(stdout, "      ioclearinbox(10);\n");
      fprintf(stdout, "      iosetinbox(10);\n");
//      fprintf(stdout, "      ioaddlines(10, 1, -25);\n"); // CHECK THIS ....
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iowrite(inbex, line, ctxt, text, osm, nsm) {\n");
      fprintf(stdout, "    var iof = iofiles[0][iofiles[0].length - 1];\n");
      fprintf(stdout, "    if (iofiles[inbex].length == 0)\n");
      fprintf(stdout, "      { iofiles[inbex].push({ in: inbex, node: iof.node, from: iof }); }\n");
      fprintf(stdout, "    iof = iofiles[inbex][iofiles[inbex].length - 1];\n");
      fprintf(stdout, "    if (iof.node.length > 0) {\n");
      fprintf(stdout, "      var ifs = iosetget('s'); ifs = 0;\n");
      fprintf(stdout, "      if (line > 0) {\n");
      fprintf(stdout, "        var lineval = stringbasecode(text);\n");
      fprintf(stdout, "        iopend(lineval, ifs, iof.node, line, ctxt, osm, nsm);\n");
      fprintf(stdout, "      } else if (line == 0) {\n");
      fprintf(stdout, "        var filecsum = text;\n");
      fprintf(stdout, "        iopend(filecsum, ifs, iof.node, line, ctxt, osm, nsm);\n");
      fprintf(stdout, "      }\n");
//      fprintf(stdout, "      console.log('iosent ' + ifv + ':' + osm + '.' + nsm);\n");
      fprintf(stdout, "    } else { console.log('ionotsent'); }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  var iomodlist = [[], [], [], [], [], [], [], [], [], [], []];\n");
      fprintf(stdout, "  var ioqueuelist = [[], [], [], [], [], [], [], [], [], [], []];\n");
      fprintf(stdout, "  function iosetmod(inbex, element, state) {\n");
      fprintf(stdout, "    if (element.id.substr(-3) == 'ln0') { return; }\n");
      fprintf(stdout, "    var mli = -1, ind = 1;\n");
      fprintf(stdout, "    while (++mli < iomodlist[inbex].length) {\n");
      fprintf(stdout, "      ind = ionamediff(element.id, iomodlist[inbex][mli].id);\n");
      fprintf(stdout, "      if (ind == 0) {\n");
      fprintf(stdout, "        if (state == -1)\n");
      fprintf(stdout, "          { iomodlist[inbex].splice(mli, 1); }\n");
      fprintf(stdout, "        return false;\n");
      fprintf(stdout, "      } else if (ind == -1) {\n");
      fprintf(stdout, "        if (state == 1)\n");
      fprintf(stdout, "          { iomodlist[inbex].splice(mli, 0, element); }\n");
      fprintf(stdout, "        break;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    if (ind == 1 && state == 1)\n");
      fprintf(stdout, "      { iomodlist[inbex].push(element); }\n");
      fprintf(stdout, "    if (state == -1)\n");
      fprintf(stdout, "      { element.className = 'muk'; }\n");
      fprintf(stdout, "    else if (state == 1) {\n");
      fprintf(stdout, "      var ecn = element.className;\n");
      fprintf(stdout, "      if (ecn == 'sel' || ecn == 'set')\n");
      fprintf(stdout, "        { element.className = 'sol'; }\n");
      fprintf(stdout, "      else { element.className = 'mod'; }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return true;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function ioqueuemods(inbex) {\n");
      fprintf(stdout, "    if (!ioqueuelist[inbex])\n");
      fprintf(stdout, "      { console.log('sync error: no queue'); return; }\n");
      fprintf(stdout, "    while (iomodlist[inbex].length > 0) {\n");
      fprintf(stdout, "      var ioline = iomodlist[inbex].shift();\n");
//      fprintf(stdout, "      ioline.className = 'mix';\n");
      fprintf(stdout, "      ioqueuelist[inbex].push(ioline);\n");
      fprintf(stdout, "    }\n");
//      fprintf(stdout, "    iohandlequeue();\n"); <- after queuemods
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iolinestring(linel) {\n");
      fprintf(stdout, "    var linecode = '';\n");
//      fprintf(stdout, "    var lnb = ionamebreak(linel.id);\n");
      fprintf(stdout, "    var chi = linel.firstElementChild;\n");
      fprintf(stdout, "    while (chi) {\n");
      fprintf(stdout, "      if (chi.tagName == 'DIV') {\n");
      fprintf(stdout, "        if (chi.className == 'subline')\n");
      fprintf(stdout, "          { linecode += '~'; }\n");
      fprintf(stdout, "        var chii = chi.firstElementChild;\n");
      fprintf(stdout, "        while (chii) {\n");
//      fprintf(stdout, "    var chi = linel.firstChild;\n");
//      fprintf(stdout, "    while (chi = chi.nextSibling) {\n");
      fprintf(stdout, "          if (chii.className.substr(-4) == 'wisp')\n");
      fprintf(stdout, "            { chii = chii.nextElementSibling; continue; }\n");
      fprintf(stdout, "          else if (chii.tagName != 'B') { break; }\n");
      fprintf(stdout, "          else {\n");
      fprintf(stdout, "            var charcode = wispascii(chii.innerHTML);\n");
      fprintf(stdout, "            linecode += String.fromCharCode(charcode);\n");
      fprintf(stdout, "            chii = chii.nextElementSibling;\n");
      fprintf(stdout, "          }\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      chi = chi.nextElementSibling;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return linecode;\n");
      fprintf(stdout, "  }\n");
//-----------------------------------------------------------------
      fprintf(stdout, "  function ioclearline(linel) {\n");
      fprintf(stdout, "    var chi = linel.firstChild;\n");
      fprintf(stdout, "    if (chi.className == 'lnum')\n");
      fprintf(stdout, "      { chi = chi.nextSibling; }\n");
      fprintf(stdout, "    while (chi) {\n");
      fprintf(stdout, "      var chtn = chi.tagName.toLowerCase();\n");
      fprintf(stdout, "      var chc = chi.className;\n");
      fprintf(stdout, "      if (chc.substr(-4) == 'wisp')\n");
      fprintf(stdout, "        { chi = chi.nextSibling; }\n");
//      fprintf(stdout, "      else if (chc == 'trigbox')\n");
//      fprintf(stdout, "        { chi = chi.nextSibling; }\n");
      fprintf(stdout, "      else if (chtn != 'b')\n");
      fprintf(stdout, "        { break; }\n");
      fprintf(stdout, "      else {\n");
      fprintf(stdout, "        var prechi = chi;\n");
      fprintf(stdout, "        chi = chi.nextSibling;\n");
      fprintf(stdout, "        linel.removeChild(prechi);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function ioclearinbox(inbex) {\n");
      fprintf(stdout, "    var inbel = $$('in' + inbex);\n");
      fprintf(stdout, "    if (!inbel) { return false; }\n");
      fprintf(stdout, "    var inbch = inbel.firstElementChild;\n");
      fprintf(stdout, "    if (inbch.className.substr(0, 8) != 'openline')\n"); //'linezero')\n");
      fprintf(stdout, "      { console.log('no line zero'); return false; }\n");
      fprintf(stdout, "    inbch = inbch.nextElementSibling;\n");
      fprintf(stdout, "    while (inbch) {\n");
      fprintf(stdout, "      var nexch = inbch.nextElementSibling;\n");
      fprintf(stdout, "      inbel.removeChild(inbch);\n");
      fprintf(stdout, "      inbch = nexch;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return true;\n");
      fprintf(stdout, "  }\n");
//-----------------------------------------------------------------
      fprintf(stdout, "  function iolinechecksum(linel) {\n");
      fprintf(stdout, "    var b62 = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';\n");
      fprintf(stdout, "    var linecount = 0;\n");
//      fprintf(stdout, "    var lnb = ionamebreak(linel.id);\n");
      fprintf(stdout, "    var charel = linel.firstChild;\n");
      fprintf(stdout, "    while (charel = charel.nextSibling) {\n");
      fprintf(stdout, "      var charcode = wispascii(charel.innerHTML);\n");
      fprintf(stdout, "      linecount += charcode;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    var lcount0 = linecount %% 62;\n");
      fprintf(stdout, "    var lcount1 = (linecount - lcount0) / 62;\n");
      fprintf(stdout, "    var lcode = b62.charAt(lcount1) + '' + b62.charAt(lcount0);\n");
      fprintf(stdout, "    return lcode;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function iohandlequeue(inbex) {\n");
      fprintf(stdout, "    if (ioqueuelist[inbex] === null) {\n");
      fprintf(stdout, "      var filesum = '';\n");
  //    fprintf(stdout, "      var ile = $$('inbox1').firstChild;\n");
  //    fprintf(stdout, "      while (ile) {\n");
  //    fprintf(stdout, "        var lcs = iolinechecksum(ile);\n");
  //    fprintf(stdout, "        filesum += '' + lcs;\n");
  //    fprintf(stdout, "        ile = ile.nextSibling;\n");
      fprintf(stdout, "      iosaving = inbex;\n"); // sum=text,0.0=context
      fprintf(stdout, "      iowrite(inbex, 0, '0.0', filesum, '-', '@@');\n");
      fprintf(stdout, "      ioqueuelist[inbex] = undefined;\n");
      fprintf(stdout, "      console.log('save ' + inbex + '...');\n");
      fprintf(stdout, "    } else if (ioqueuelist[inbex] && ioqueuelist[inbex].length > 0) {\n");
      fprintf(stdout, "      var mek = ioqueuelist[inbex].shift();\n");
      fprintf(stdout, "      var inb = ionamebreak(mek.id);\n");
      fprintf(stdout, "      if (inb[0] != 'in') { return; }\n");
      fprintf(stdout, "      var insfx = 0;\n");
      fprintf(stdout, "      if (inb[0] == '.') {\n");
      fprintf(stdout, "        var isb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "        insfx = isb[1];\n");
      fprintf(stdout, "        inb[2] = isb[2];\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      var insuffix = (insfx == 0) ? '' : '.' + insfx;\n");
      fprintf(stdout, "      var lnb = ionamebreak(inb[2]);\n");
      fprintf(stdout, "      if (lnb[0] != 'ln') { return; }\n");
      fprintf(stdout, "      if (lnb[1] == 0) {\n");
      fprintf(stdout, "        \n");
      fprintf(stdout, "        return;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      var linespan = mek.firstElementChild.innerHTML;\n");
      fprintf(stdout, "      var linelidx = linespan.lastIndexOf('>');\n");
      fprintf(stdout, "      if (linelidx >= 0)\n"); // remove child <> prefixes
      fprintf(stdout, "        { linespan = linespan.substr(linelidx + 1); }\n");
      fprintf(stdout, "      var linestart = ionamebreak(linespan);\n");
      fprintf(stdout, "      var linestr = '';\n");
      fprintf(stdout, "      var shouldsave = 1;\n");
      fprintf(stdout, "      var oldsum = '-', newsum = '-';\n");
      fprintf(stdout, "      if (linestart[0] == '=') {\n");
      fprintf(stdout, "        var linelen = ionamebreak(linestart[2]);\n");
      fprintf(stdout, "        var linelim = ionamebreak(linelen[2]);\n");
//      fprintf(stdout, "        oldsum = '-' + linelen[1];\n");
//      fprintf(stdout, "        newsum = '-' + linelim[1];\n");
      fprintf(stdout, "        linestr = '(' + linelen[0] + linelen[1];\n");
      fprintf(stdout, "        linestr += linelim[0] + linelim[1] + ')';\n");
      fprintf(stdout, "        shouldsave = 0;\n");
      fprintf(stdout, "        var linestop = linestart[1] + linelen[1] - 1;\n");
      fprintf(stdout, "        if (linelim[1] >= linestart[1] && linestop > linelim[1])\n");
      fprintf(stdout, "          { linestop = linelim[1]; }\n");
      fprintf(stdout, "        var lsi = linestart[1] - 1;\n");
      fprintf(stdout, "        while (++lsi <= linestop) {\n");
      fprintf(stdout, "          var lsid = $$('in' + inb[1] + 'ln' + lsi);\n");
      fprintf(stdout, "          var lscn = lsid.className;\n");
      fprintf(stdout, "          if (lscn == 'sel' || lscn == 'set')\n");
      fprintf(stdout, "            { lsid.className = 'sal'; }\n");
      fprintf(stdout, "          else { lsid.className = 'mak'; }\n");
      fprintf(stdout, "        }\n");
      fprintf(stdout, "      } else if (linestart[0] == '+') {\n");
      fprintf(stdout, "        linestr = iolinestring(mek);\n");
      fprintf(stdout, "        oldsum = '-';\n");
      fprintf(stdout, "        newsum = iolinechecksum(mek);\n");
      fprintf(stdout, "        var mcn = mek.className;\n");
      fprintf(stdout, "        if (mcn == 'sel' || mcn == 'set')\n");
      fprintf(stdout, "          { mek.className = 'sal'; }\n");
      fprintf(stdout, "        else { mek.className = 'mak'; }\n");
      fprintf(stdout, "      } else if (linestart[0] == '-') {\n");
      fprintf(stdout, "        linestr = iolinestring(mek);\n");
      fprintf(stdout, "        oldsum = iolinechecksum(mek);\n");
      fprintf(stdout, "        newsum = '-';\n");
      fprintf(stdout, "        mek.className = 'muk';\n");
// else if linestart[0] == '^' ... no action but need to remove (return call)
      fprintf(stdout, "      } else if (linestart[0] == '') {\n");
      fprintf(stdout, "        linestr = iolinestring(mek);\n");
      fprintf(stdout, "        oldsum = '00';\n");
      fprintf(stdout, "        newsum = iolinechecksum(mek);\n");
      fprintf(stdout, "        var mcn = mek.className;\n");
      fprintf(stdout, "        if (mcn == 'sel' || mcn == 'set')\n");
      fprintf(stdout, "          { mek.className = 'sox'; }\n");
      fprintf(stdout, "        else { mek.className = 'mix'; }\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      var context = inb[1] + '.' + insfx;\n");
      fprintf(stdout, "      if (ioqueuelist[inbex].length == 0 && shouldsave == 1)\n");
      fprintf(stdout, "        { ioqueuelist[inbex] = null; }\n");
      fprintf(stdout, "      iowrite(inbex, lnb[1], context, linestr, oldsum, newsum);\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      // -----------------------------------------------------------------------------------
      fprintf(stdout, "  var copying = undefined;\n");
      fprintf(stdout, "  var pasting = undefined;\n");
      fprintf(stdout, "  function pastefocus() {\n");
      fprintf(stdout, "    if (pasting === undefined) {\n");
      fprintf(stdout, "      $$('pastebox').style.display = 'none';\n");
      fprintf(stdout, "      $$('pastext').style.display = 'block';\n");
      fprintf(stdout, "      $$('pastelink').style.display = 'none';\n");
      fprintf(stdout, "      $$('pastext').value = '';\n");
      fprintf(stdout, "      copying = false;\n");
      fprintf(stdout, "      pasting = false;\n");
      fprintf(stdout, "    } else if (pasting == false) {\n");
      fprintf(stdout, "      var pasteurl = $$('pastext').value;\n");
      fprintf(stdout, "      var phttp = (pasteurl.substr(0, 7) == 'http://');\n");
      fprintf(stdout, "      var phttps = (pasteurl.substr(0, 8) == 'https://');\n");
      fprintf(stdout, "      if (copying == true && (phttp || phttps)) {\n");
      fprintf(stdout, "        $$('pastext').style.display = 'none';\n");
      fprintf(stdout, "        $$('pastelink').style.display = 'block';\n");
      fprintf(stdout, "        $$('pastelink').href = pasteurl;\n");
      fprintf(stdout, "        $$('pastelink').innerHTML = pasteurl;\n");
      fprintf(stdout, "        copying = undefined;\n");
      fprintf(stdout, "        pasting = undefined;\n");
      fprintf(stdout, "      } else {\n");
      fprintf(stdout, "        $$('pastebox').style.display = 'block';\n");
      fprintf(stdout, "        $$('pastext').style.display = 'block';\n");
      fprintf(stdout, "        $$('pastelink').style.display = 'none';\n");
      fprintf(stdout, "        $$('pastext').focus();\n");
      fprintf(stdout, "        copying = false;\n");
      fprintf(stdout, "        pasting = true;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    } else if (pasting == true) {\n");
      fprintf(stdout, "      var ptx = $$('pastext').value;\n");
      fprintf(stdout, "      if (ptx.substr(0, 7) == 'http://')\n");
      fprintf(stdout, "        { ptx = '#/' + ptx.substr(7); }\n");
      fprintf(stdout, "      else if (ptx.substr(0, 8) == 'https://')\n");
      fprintf(stdout, "        { ptx = '$/' + ptx.substr(8); }\n");
      fprintf(stdout, "      else if (ptx.substr(0, 8) == 'cache://')\n");
      fprintf(stdout, "        { ptx = '%/' + ptx.substr(8); }\n");
      fprintf(stdout, "      copying = false;\n");
      fprintf(stdout, "      pasting = false;\n");
      fprintf(stdout, "      while (ptx.length > 0) {\n");
      fprintf(stdout, "        var pcc = ptx.charCodeAt(0);\n");
//      fprintf(stdout, "        if (pcc >= 97 && pcc <= 122)\n");
//      fprintf(stdout, "          { pcc -= 32; }\n");
      fprintf(stdout, "        var psk = false;\n");
      fprintf(stdout, "        if (pcc >= 37 && pcc <= 40)\n");
      fprintf(stdout, "          { pcc += 300; }\n");
      fprintf(stdout, "        else if (pcc == 91 || pcc == 93)\n");
      fprintf(stdout, "          { pcc += 300; }\n");
      fprintf(stdout, "        var pce = { keyCode: pcc, shiftKey: false\n");
      fprintf(stdout, "                  , altKey: false, ctrlKey: false\n");
      fprintf(stdout, "                  , preventDefault: false }\n");
      fprintf(stdout, "        if (pcc >= 65 && pcc <= 90)\n");
      fprintf(stdout, "          { pce.shiftKey = true; }\n");
      fprintf(stdout, "        ptx = ptx.substr(1);\n");
      fprintf(stdout, "        window.onkeydown(pce);\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      $$('pastebox').style.display = 'none';\n");
      fprintf(stdout, "      $$('pastext').value = '';\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return pasting;\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function copyfocus() {\n");
      fprintf(stdout, "    if (copying === undefined) {\n");
      fprintf(stdout, "      pastefocus();\n");
      fprintf(stdout, "    } else if (copying == false) {\n");
      fprintf(stdout, "      var thisline = lineid[inbosel];\n");
      fprintf(stdout, "      var ltx = iolinestring(thisline);\n");
      fprintf(stdout, "      if (ltx.substr(0, 2) == '#/')\n");
      fprintf(stdout, "        { ltx = 'http://' + ltx.substr(2); }\n");
      fprintf(stdout, "      else if (ltx.substr(0, 2) == '$/')\n");
      fprintf(stdout, "        { ltx = 'https://' + ltx.substr(2); }\n");
      fprintf(stdout, "      else if (ltx.substr(0, 2) == '%/')\n");
      fprintf(stdout, "        { ltx = 'cache://' + ltx.substr(2); }\n");
      fprintf(stdout, "      $$('pastext').value = ltx;\n");
      fprintf(stdout, "      $$('pastebox').style.display = 'block';\n");
 //     fprintf(stdout, "      $$('pastext').focus();\n");
      fprintf(stdout, "      $$('pastext').select();\n");
      fprintf(stdout, "      copying = true;\n");
      fprintf(stdout, "      pasting = false;\n");
      fprintf(stdout, "    } else if (copying == true) {\n");
      fprintf(stdout, "      $$('pastebox').style.display = 'none';\n");
      fprintf(stdout, "      $$('pastext').value = '';\n");
      fprintf(stdout, "      copying = false;\n");
      fprintf(stdout, "      pasting = false;\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "    return copying;\n");
      fprintf(stdout, "  }\n");
      // -----------------------------------------------------------------------------------
      fprintf(stdout, "  var loading = undefined;\n");
//      fprintf(stdout, "  function loadload(el) {\n");
//      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function loadinsertline(linevalue) {\n");
      fprintf(stdout, "    pasting = true;\n");
      fprintf(stdout, "    wispgoto('tsol');\n");
      fprintf(stdout, "    $$('pastext').value = linevalue;\n");
      fprintf(stdout, "    pastefocus();\n");
      fprintf(stdout, "    wispaddline('s');\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function loadcompleted() {\n");
//      fprintf(stdout, "    $$('loadbox').style.display = 'none';\n");
//      fprintf(stdout, "    loading = false;\n");
//      fprintf(stdout, "    $$('loadbox').src = '/~@/ulf?-';\n");
      fprintf(stdout, "    bodyundrag();\n");
      fprintf(stdout, "  }\n");
/*
      fprintf(stdout, "    } else {\n");
      fprintf(stdout, "      var loadfile = ldoc.getElementById('loadfile');\n");
      fprintf(stdout, "      if (loadfile && loadfile.innerHTML != '') {\n");
      fprintf(stdout, "        loadfile = JSON.parse(loadfile.innerHTML);\n");
      fprintf(stdout, "        pasting = true;\n");
      fprintf(stdout, "        wispgoto('teol');\n");
      fprintf(stdout, "        $$('pastext').value = loadfile.path;\n");
      fprintf(stdout, "        pastefocus();\n");
//      fprintf(stdout, "        highlightprevline(1);\n");
//      fprintf(stdout, "        wispaddline('p');\n");
//      fprintf(stdout, "        var thisline = lineid[inbosel];\n");
//      fprintf(stdout, "        var lframe = $$('loadframe');\n");
//      fprintf(stdout, "        thisline.appendChild(lframe);\n");
//      fprintf(stdout, "        lframe.id = thisline.id + 'lf0';\n");
      fprintf(stdout, "        $$('loadbox').style.display = 'none';\n");
      fprintf(stdout, "        loading = false;\n");
      fprintf(stdout, "        wispaddline('s');\n"); // should be empty, but just in case
//      fprintf(stdout, "        wispgoto('nsol');\n");
//      fprintf(stdout, "        lhtml = '<iframe id=\"loadframe\" onload=\"loadload(this);\"></iframe>';\n");
//      fprintf(stdout, "        $$('loadbox').innerHTML = lhtml;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
*/
      fprintf(stdout, "  function bodydrag() {\n");
      fprintf(stdout, "    if (!loading) {\n");
      fprintf(stdout, "      loading = true;\n");
      fprintf(stdout, "      var ldoc = $$('loadframe').contentWindow.document;\n");
      fprintf(stdout, "      if (!ldoc) { return; }\n");
      fprintf(stdout, "      var lnode = ldoc.getElementById('node');\n");
      fprintf(stdout, "      if (lnode) {\n");
      fprintf(stdout, "        var nodes = iofiles[inbosel];\n");
      fprintf(stdout, "        lnode.value = nodes[nodes.length - 1].node;\n");
      fprintf(stdout, "      }\n");
      fprintf(stdout, "      $$('loadbox').className = 'vis';\n");
//      fprintf(stdout, "      $$('loadframe').src = '%s?-';\n", TABULFURL);
      fprintf(stdout, "      $$('loadbox').style.display = 'block';\n");
      fprintf(stdout, "    }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function bodyundrag() {\n");
      fprintf(stdout, "    $$('loadbox').style.display = 'none';\n");
      fprintf(stdout, "    loading = false;\n");
      fprintf(stdout, "    $$('loadframe').src = '%s?-';\n", TABULFURL);
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function bodydragtoggle() {\n");
      fprintf(stdout, "    if (!loading) { bodydrag(); }\n");
      fprintf(stdout, "    else { bodyundrag(); }\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function loaddrag() {\n");
      fprintf(stdout, "    $$('loadbox').className = 'act';\n");
      fprintf(stdout, "  }\n");
      fprintf(stdout, "  function loadundrag() {\n");
      fprintf(stdout, "    $$('loadbox').className = 'vis';\n");
      fprintf(stdout, "  }\n");
      // -----------------------------------------------------------------------------------
#include "tabkey.h"
#include "tabtouch.h"
#include "tabmess.h"
      fprintf(stdout, "</script></head>\n"); // <code><div id=\"frame\">\n");
      fprintf(stdout, "<body ondragenter=\"bodydrag();\">\n"); // ondragleave=\"bodyundrag();\">\n");
      fflush(stdout);
      char *arrvaluehead = "  \"l%d\": { \"txt\": \"";
      char *arrvaluenext = "\", \"rtf\": \"";
      char *arrvaluetailnext = "\" },\n";
      char *arrvaluetailtail = "\" }\n";
      fprintf(stdout, "<div id=\"inbox\">\n");
/*
      fprintf(stdout, "<script type=\"text/javascript\">\n");
      // build path name
      pathname[0] = '\0';
      strsnap(pathname, bufname);
      if (!strendswith(pathname, "/"))
        { strsnap(pathname, "/"); }
      strsnap(pathname, filename);
      // open file
      FILE *filp = fopen(pathname, "r");
      if (filp == NULL) {
        fprintf(stdout, "  inboxdata.lines = {\n");
        linebuf[0] = '\0';
        fprintf(stdout, arrvaluehead, 1);
        writebufclean(linebuf, 0);
        fprintf(stdout, arrvaluenext);
        writebufhighlight(linebuf, 0);
        fprintf(stdout, arrvaluetailtail);
        fprintf(stdout, "  };\n");
        fprintf(stdout, "  inboxdata.numlines = %d;\n", 1);
        fflush(stdout);
      } else {
        // get file size
        fseek(filp, 0, SEEK_END);
        int filelen = (int)ftell(filp);
        fseek(filp, 0, SEEK_SET);
        // read lines
        fprintf(stdout, "  inboxdata.lines = {\n");
        int linenum = 0;
        int linelen = 0;
        while (linelen != -1) {
          linelen = readline(filp, linebuf, STREAMBUFFERLINESIZE, 0);
          if (linelen == -1) { break; }
          linenum++;    // maybe switch to basecode and merge lastline ...
          if (linelen >= 0) {
            fprintf(stdout, arrvaluehead, linenum);
            writebufclean(linebuf, 0);
            fprintf(stdout, arrvaluenext);
            writebufhighlight(linebuf, 0);
            fprintf(stdout, arrvaluetailnext);
            fflush(stdout);
          } else {
            // final line has linelen == -2, -3, -4 for linelen 0, 1, 2
            fprintf(stdout, arrvaluehead, linenum);
            writebufclean(linebuf, 0);
            fprintf(stdout, arrvaluenext);
            writebufhighlight(linebuf, 0);
            fprintf(stdout, arrvaluetailtail);
            fflush(stdout);
            break;
          }
        }
        fprintf(stdout, "  };\n");
        fprintf(stdout, "  inboxdata.numlines = %d;\n", linenum);
        fclose(filp);
      }
      fprintf(stdout, "</script>\n");
*/
      fprintf(stdout, "</div>\n");
      fprintf(stdout, "<div id=\"logbox\"><span id=\"logtext\"></span></div>");
      fprintf(stdout, "<div id=\"optbox\">...</div>\n");
      fprintf(stdout, "<div id=\"trigbox\"></div>\n");
      fprintf(stdout, "<div id=\"commbox0\">...</div>\n");
      fprintf(stdout, "<div id=\"commbox1\">...</div>\n");
      fprintf(stdout, "<div id=\"commbox2\">...</div>\n");
      fprintf(stdout, "<div id=\"commbox3\">...</div>\n");
      fprintf(stdout, "<div id=\"loadbox\">\n");
      fprintf(stdout, "<iframe id=\"loadframe\"></iframe>\n"); // onload=\"loadload(this);\"></iframe>\n");
      fprintf(stdout, "<div id=\"loadoverlay\"></div>\n");
//      fprintf(stdout, " ondragenter=\"loaddrag();\" ondragleave=\"loadundrag();\"></iframe>\n");
      fprintf(stdout, "</div>\n");
      fprintf(stdout, "<div id=\"pastebox\">\n");
      fprintf(stdout, "<textarea id=\"pastext\"></textarea>\n");
      fprintf(stdout, "<a id=\"pastelink\" href=\"\" target=\"_blank\"></a>\n");
      fprintf(stdout, "</div>\n");
//      fprintf(stdout, "<div id=\"iobox\">\n");
//      fprintf(stdout, "<iframe id=\"ioframe\" onload=\"ioload();\"></iframe>\n");
//      fprintf(stdout, "</div>\n");
      fflush(stdout);
//      fprintf(stdout, "</div></code>
      fprintf(stdout, "<script type=\"text/javascript\">\n");
//      fprintf(stdout, "  rebuildinbox(0, 50);\n");
//      fprintf(stdout, "  highlightnextline(1);\n");
//      fprintf(stdout, "  ioqueuelist = [[], [], [], [], [], [], [], [], [], [], []];\n");
      fprintf(stdout, "  var ini = 11;\n"); // 10 = cmd
      fprintf(stdout, "  while (--ini >= 0)\n");
      fprintf(stdout, "    { ioaddinbox(ini, 0); }\n");
//      fprintf(stdout, "  ioclearinboxpages(9);\n");
//      fprintf(stdout, "  ioaddlines(9, 1, -25);\n"); // if lastChild == bluewisp don't add..
//      fprintf(stdout, "  iosetinbox(9);\n");
      fprintf(stdout, "  ioopen(0, '~', 9);\n");
      fprintf(stdout, "  ioaddlines(9, 1, -25);\n");
      fprintf(stdout, "  touchenable();\n");
      fprintf(stdout, "  messenable();\n");
      fprintf(stdout, "  pastefocus();\n");
      fprintf(stdout, "  bodyundrag();\n");
      fprintf(stdout, "  loadcompleted();\n");
      fprintf(stdout, "  highlightnextline(0);\n");
      IF (selectline GT 0) {
        LOG1N("  highlightwhenadded(9, %d, 1);", selectline);
      } EF (selectline EQ 0) {
        LOGN("  highlightwhenadded(9, 1, 0);");
      }
//      fprintf(stdout, "  wispswitch();\n");
      fprintf(stdout, "  wisptoggletab();\n");
      fprintf(stdout, "</script></body></html>\n");
      fflush(stdout);
    }
  }
  return 0;
}
